; Generated by Brainhair Compiler
bits 32

extern syscall1
extern syscall3
extern syscall6
extern gc_get_stack_pointer
extern gc_get_stack_bottom
extern gc_set_stack_bottom
extern gc_scan_stack
extern gc_memory_barrier
extern gc_atomic_set
extern gc_atomic_get
extern gc_atomic_cas

section .data
str_0: db "heap_base: ", 0
str_1: db 10, 0
str_2: db "A1", 10, 0
str_3: db "A2", 10, 0
str_4: db "A3", 10, 0
str_5: db "A4", 10, 0
str_6: db "A5", 10, 0
str_7: db "A6", 10, 0
str_8: db "obj_addr: ", 0
str_9: db 10, 0
str_10: db "A8", 10, 0
str_11: db "A9", 10, 0

section .bss
gc_heap_base: resb 4
gc_heap_size: resb 4
gc_heap_used: resb 4
gc_object_list: resb 4
gc_object_count: resb 4
gc_bytes_since_collect: resb 4
gc_enabled: resb 4
gc_initialized: resb 4
gc_total_allocations: resb 4
gc_total_collections: resb 4
gc_total_freed: resb 4
gc_root_addrs: resb 1024
gc_root_count: resb 4
gc_free_list: resb 4
gc_padding1: resb 16
gc_padding2: resb 4

section .text
global _start
global get_argc
global get_argv

section .bss
_startup_esp: resd 1

section .text

_start:
    mov [_startup_esp], esp  ; Save initial stack pointer
    call main
    ; Exit with return code from main
    mov ebx, eax  ; Exit code
    mov eax, 1    ; sys_exit
    int 0x80

; get_argc() - returns argument count
get_argc:
    mov eax, [_startup_esp]
    mov eax, [eax]  ; argc is at [esp]
    ret

; get_argv(index) - returns pointer to argument string
get_argv:
    push ebp
    mov ebp, esp
    mov eax, [_startup_esp]
    mov ecx, [ebp+8]  ; index
    lea eax, [eax + 4 + ecx*4]  ; argv[index] = esp + 4 + index*4
    mov eax, [eax]
    pop ebp
    ret
    
gc_debug_write:
    push ebp
    mov ebp, esp
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
gc_debug_write_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_debug_hex:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, 48
    push eax
    mov eax, 0
    mov ebx, eax
    lea eax, [rel gc_padding1]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, 120
    push eax
    mov eax, 1
    mov ebx, eax
    lea eax, [rel gc_padding1]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, 0
    mov [ebp-4], eax
while_start0:
    mov eax, [ebp-4]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end1
    mov eax, [ebp+8]
    push eax
    mov eax, 28
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    mov ecx, ebx
    shr eax, cl
    push eax
    mov eax, 15
    mov ebx, eax
    pop eax
    and eax, ebx
    mov [ebp-8], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else3
    mov eax, 48
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    lea eax, [rel gc_padding1]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    jmp endif2
else3:
    mov eax, 97
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    sub eax, ebx
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    lea eax, [rel gc_padding1]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
endif2:
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start0
while_end1:
    mov eax, 10
    push eax
    lea eax, [rel gc_padding1]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
gc_debug_hex_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_init:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_initialized]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else5
    mov eax, 1
    jmp gc_init_return
    jmp endif4
else5:
endif4:
    mov eax, 0
    push eax
    mov eax, 1
    neg eax
    push eax
    mov eax, 2
    push eax
    mov eax, 32
    mov ebx, eax
    pop eax
    or eax, ebx
    push eax
    mov eax, 1
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    or eax, ebx
    push eax
    mov eax, 4194304
    push eax
    mov eax, 0
    push eax
    mov eax, 192
    push eax
    call syscall6
    add esp, 28
    mov [rel gc_heap_base], eax
    mov eax, 11
    push eax
    lea eax, [rel str_0]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [rel gc_heap_base]
    push eax
    call gc_debug_hex
    add esp, 4
    mov eax, 1
    push eax
    lea eax, [rel str_1]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, 4194304
    mov [rel gc_heap_size], eax
    mov eax, 0
    mov [rel gc_heap_used], eax
    mov eax, 0
    mov [rel gc_object_list], eax
    mov eax, 0
    mov [rel gc_object_count], eax
    mov eax, 0
    mov [rel gc_bytes_since_collect], eax
    mov eax, 0
    mov [rel gc_free_list], eax
    mov eax, 0
    mov [rel gc_root_count], eax
    call gc_get_stack_pointer
    push eax
    mov eax, 65536
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    call gc_set_stack_bottom
    add esp, 4
    mov eax, 1
    mov [rel gc_initialized], eax
    mov eax, 1
    jmp gc_init_return
gc_init_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_alloc:
    push ebp
    mov ebp, esp
    sub esp, 68
    mov eax, 3
    push eax
    lea eax, [rel str_2]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [rel gc_initialized]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else7
    call gc_init
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else9
    mov eax, 0
    jmp gc_alloc_return
    jmp endif8
else9:
endif8:
    jmp endif6
else7:
endif6:
    mov eax, 3
    push eax
    lea eax, [rel str_3]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [ebp+8]
    push eax
    mov eax, 3
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 4
    neg eax
    mov ebx, eax
    pop eax
    and eax, ebx
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    mov eax, 3
    push eax
    lea eax, [rel str_4]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, 3
    push eax
    lea eax, [rel str_5]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, 0
    mov [ebp-12], eax
    mov eax, [rel gc_free_list]
    mov [ebp-16], eax
while_start10:
    mov eax, [ebp-16]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end11
    mov eax, [ebp-16]
    mov [ebp-20], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-24], eax
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else13
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-28], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else15
    mov eax, [ebp-28]
    mov [rel gc_free_list], eax
    jmp endif14
else15:
    mov eax, [ebp-12]
    mov [ebp-32], eax
    mov eax, [ebp-28]
    push eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-32]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
endif14:
    mov eax, 0
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [rel gc_object_list]
    push eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, 0
    push eax
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [rel gc_object_list]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else17
    mov eax, [rel gc_object_list]
    mov [ebp-36], eax
    mov eax, [ebp-16]
    push eax
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-36]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    jmp endif16
else17:
endif16:
    mov eax, [ebp-16]
    mov [rel gc_object_list], eax
    mov eax, [rel gc_object_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_object_count], eax
    mov eax, [rel gc_total_allocations]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_total_allocations], eax
    mov eax, [ebp-16]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-40], eax
    mov eax, 0
    mov [ebp-44], eax
while_start18:
    mov eax, [ebp-44]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end19
    mov eax, 0
    push eax
    mov eax, [ebp-44]
    mov ebx, eax
    mov eax, [ebp-40]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp-44]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-44], eax
    jmp while_start18
while_end19:
    mov eax, [ebp-40]
    jmp gc_alloc_return
    jmp endif12
else13:
endif12:
    mov eax, [ebp-16]
    mov [ebp-12], eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-16], eax
    jmp while_start10
while_end11:
    mov eax, 3
    push eax
    lea eax, [rel str_6]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, 3
    push eax
    lea eax, [rel str_7]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [rel gc_heap_base]
    push eax
    mov eax, [rel gc_heap_used]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-48], eax
    mov eax, 10
    push eax
    lea eax, [rel str_8]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [ebp-48]
    push eax
    call gc_debug_hex
    add esp, 4
    mov eax, 1
    push eax
    lea eax, [rel str_9]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [ebp-48]
    mov [ebp-52], eax
    mov eax, 3
    push eax
    lea eax, [rel str_10]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, 0
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-52]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, 3
    push eax
    lea eax, [rel str_11]
    push eax
    call gc_debug_write
    add esp, 8
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-52]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [rel gc_object_list]
    push eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-52]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, 0
    push eax
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-52]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [rel gc_object_list]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else21
    mov eax, [rel gc_object_list]
    mov [ebp-56], eax
    mov eax, [ebp-48]
    push eax
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-56]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    jmp endif20
else21:
endif20:
    mov eax, [ebp-48]
    mov [rel gc_object_list], eax
    mov eax, [rel gc_object_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_object_count], eax
    mov eax, [rel gc_heap_used]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_heap_used], eax
    mov eax, [rel gc_bytes_since_collect]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_bytes_since_collect], eax
    mov eax, [rel gc_total_allocations]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_total_allocations], eax
    mov eax, [ebp-48]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-60], eax
    mov eax, [ebp-60]
    mov [ebp-64], eax
    mov eax, 0
    mov [ebp-68], eax
while_start22:
    mov eax, [ebp-68]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end23
    mov eax, 0
    push eax
    mov eax, [ebp-68]
    mov ebx, eax
    mov eax, [ebp-64]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp-68]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-68], eax
    jmp while_start22
while_end23:
    mov eax, [ebp-60]
    jmp gc_alloc_return
gc_alloc_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_alloc_typed:
    push ebp
    mov ebp, esp
    sub esp, 12
    mov eax, [ebp+8]
    push eax
    call gc_alloc
    add esp, 4
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else25
    mov eax, [ebp-4]
    jmp gc_alloc_typed_return
    jmp endif24
else25:
endif24:
    mov eax, [ebp-4]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-8], eax
    mov eax, [ebp-8]
    mov [ebp-12], eax
    mov eax, [ebp+12]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    mov ecx, ebx
    shl eax, cl
    push eax
    mov eax, 2
    neg eax
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [ebp-4]
    jmp gc_alloc_typed_return
gc_alloc_typed_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_register_root:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_root_count]
    push eax
    mov eax, 256
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else27
    mov eax, 0
    jmp gc_register_root_return
    jmp endif26
else27:
endif26:
    mov eax, [ebp+8]
    push eax
    mov eax, [rel gc_root_count]
    mov ebx, eax
    lea eax, [rel gc_root_addrs]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [rel gc_root_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_root_count], eax
    mov eax, 1
    jmp gc_register_root_return
gc_register_root_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_unregister_root:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, 0
    mov [ebp-4], eax
while_start28:
    mov eax, [ebp-4]
    push eax
    mov eax, [rel gc_root_count]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end29
    mov eax, [ebp-4]
    mov ebx, eax
    lea eax, [rel gc_root_addrs]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, [ebp+8]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else31
    mov eax, [ebp-4]
    mov [ebp-8], eax
while_start32:
    mov eax, [ebp-8]
    push eax
    mov eax, [rel gc_root_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end33
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    lea eax, [rel gc_root_addrs]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    lea eax, [rel gc_root_addrs]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    jmp while_start32
while_end33:
    mov eax, [rel gc_root_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [rel gc_root_count], eax
    mov eax, 1
    jmp gc_unregister_root_return
    jmp endif30
else31:
endif30:
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start28
while_end29:
    mov eax, 0
    jmp gc_unregister_root_return
gc_unregister_root_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_is_valid_pointer:
    push ebp
    mov ebp, esp
    sub esp, 16
    mov eax, [rel gc_heap_base]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else35
    mov eax, 0
    jmp gc_is_valid_pointer_return
    jmp endif34
else35:
endif34:
    mov eax, [rel gc_heap_used]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else37
    mov eax, 0
    jmp gc_is_valid_pointer_return
    jmp endif36
else37:
endif36:
    mov eax, [ebp+8]
    push eax
    mov eax, [rel gc_heap_base]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else39
    mov eax, 0
    jmp gc_is_valid_pointer_return
    jmp endif38
else39:
endif38:
    mov eax, [ebp+8]
    push eax
    mov eax, [rel gc_heap_base]
    push eax
    mov eax, [rel gc_heap_used]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else41
    mov eax, 0
    jmp gc_is_valid_pointer_return
    jmp endif40
else41:
endif40:
    mov eax, [rel gc_object_list]
    mov [ebp-4], eax
while_start42:
    mov eax, [ebp-4]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end43
    mov eax, [ebp-4]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    mov eax, [ebp-4]
    mov [ebp-12], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-16], eax
    mov eax, [ebp+8]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else45
    mov eax, [ebp+8]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp-16]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else47
    mov eax, [ebp-4]
    jmp gc_is_valid_pointer_return
    jmp endif46
else47:
endif46:
    jmp endif44
else45:
endif44:
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-4], eax
    jmp while_start42
while_end43:
    mov eax, 0
    jmp gc_is_valid_pointer_return
gc_is_valid_pointer_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_mark_object:
    push ebp
    mov ebp, esp
    sub esp, 32
    mov eax, [ebp+8]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else49
    jmp gc_mark_object_return
    jmp endif48
else49:
endif48:
    mov eax, [ebp+8]
    mov [ebp-4], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-4]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else51
    jmp gc_mark_object_return
    jmp endif50
else51:
endif50:
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-4]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    or eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-4]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [ebp+8]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-4]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-12], eax
    mov eax, [ebp-8]
    mov [ebp-16], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    xor edx, edx
    idiv ebx
    mov [ebp-20], eax
    mov eax, 0
    mov [ebp-24], eax
while_start52:
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-20]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end53
    mov eax, [ebp-24]
    mov ebx, eax
    mov eax, [ebp-16]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    call gc_is_valid_pointer
    add esp, 4
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else55
    mov eax, [ebp-32]
    push eax
    call gc_mark_object
    add esp, 4
    jmp endif54
else55:
endif54:
    mov eax, [ebp-24]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-24], eax
    jmp while_start52
while_end53:
gc_mark_object_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_mark_root:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, [ebp+8]
    push eax
    call gc_is_valid_pointer
    add esp, 4
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else57
    mov eax, [ebp-4]
    push eax
    call gc_mark_object
    add esp, 4
    jmp endif56
else57:
endif56:
gc_mark_root_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_mark:
    push ebp
    mov ebp, esp
    sub esp, 12
    mov eax, 0
    mov [ebp-4], eax
while_start58:
    mov eax, [ebp-4]
    push eax
    mov eax, [rel gc_root_count]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end59
    mov eax, [ebp-4]
    mov ebx, eax
    lea eax, [rel gc_root_addrs]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-8], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-8]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-12], eax
    mov eax, [ebp-12]
    push eax
    call gc_mark_root
    add esp, 4
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start58
while_end59:
    mov eax, 0
gc_mark_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_sweep:
    push ebp
    mov ebp, esp
    sub esp, 32
    mov eax, 0
    mov [ebp-4], eax
    mov eax, [rel gc_object_list]
    mov [ebp-8], eax
while_start60:
    mov eax, [ebp-8]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end61
    mov eax, [ebp-8]
    mov [ebp-12], eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-16], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else63
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    push eax
    mov eax, 2
    neg eax
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    jmp endif62
else63:
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-20], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-24], eax
    mov eax, [ebp-20]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else65
    mov eax, [ebp-20]
    mov [ebp-28], eax
    mov eax, [ebp-16]
    push eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-28]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    jmp endif64
else65:
    mov eax, [ebp-16]
    mov [rel gc_object_list], eax
endif64:
    mov eax, [ebp-16]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else67
    mov eax, [ebp-16]
    mov [ebp-32], eax
    mov eax, [ebp-20]
    push eax
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp-32]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    jmp endif66
else67:
endif66:
    mov eax, [rel gc_free_list]
    push eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-12]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [ebp-8]
    mov [rel gc_free_list], eax
    mov eax, [rel gc_object_count]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [rel gc_object_count], eax
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp-24]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    mov eax, [rel gc_total_freed]
    push eax
    mov eax, [ebp-24]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_total_freed], eax
endif62:
    mov eax, [ebp-16]
    mov [ebp-8], eax
    jmp while_start60
while_end61:
    mov eax, [ebp-4]
    jmp gc_sweep_return
gc_sweep_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_collect:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, [rel gc_initialized]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else69
    mov eax, 0
    jmp gc_collect_return
    jmp endif68
else69:
endif68:
    call gc_memory_barrier
    call gc_mark
    call gc_sweep
    mov [ebp-4], eax
    mov eax, 0
    mov [rel gc_bytes_since_collect], eax
    mov eax, [rel gc_total_collections]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [rel gc_total_collections], eax
    call gc_memory_barrier
    mov eax, [ebp-4]
    jmp gc_collect_return
gc_collect_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_enable:
    push ebp
    mov ebp, esp
    mov eax, 1
    mov [rel gc_enabled], eax
gc_enable_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_disable:
    push ebp
    mov ebp, esp
    mov eax, 0
    mov [rel gc_enabled], eax
gc_disable_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_heap_used:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_heap_used]
    jmp gc_get_heap_used_return
gc_get_heap_used_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_heap_size:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_heap_size]
    jmp gc_get_heap_size_return
gc_get_heap_size_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_object_count:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_object_count]
    jmp gc_get_object_count_return
gc_get_object_count_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_total_allocations:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_total_allocations]
    jmp gc_get_total_allocations_return
gc_get_total_allocations_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_total_collections:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_total_collections]
    jmp gc_get_total_collections_return
gc_get_total_collections_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_get_total_freed:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_total_freed]
    jmp gc_get_total_freed_return
gc_get_total_freed_return:
    mov esp, ebp
    pop ebp
    ret
    
gc_destroy:
    push ebp
    mov ebp, esp
    mov eax, [rel gc_initialized]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else71
    mov eax, 0
    push eax
    mov eax, 0
    push eax
    mov eax, 0
    push eax
    mov eax, 0
    push eax
    mov eax, [rel gc_heap_size]
    push eax
    mov eax, [rel gc_heap_base]
    push eax
    mov eax, 91
    push eax
    call syscall6
    add esp, 28
    mov eax, 0
    mov [rel gc_heap_base], eax
    mov eax, 0
    mov [rel gc_heap_size], eax
    mov eax, 0
    mov [rel gc_heap_used], eax
    mov eax, 0
    mov [rel gc_object_list], eax
    mov eax, 0
    mov [rel gc_free_list], eax
    mov eax, 0
    mov [rel gc_object_count], eax
    mov eax, 0
    mov [rel gc_root_count], eax
    mov eax, 0
    mov [rel gc_initialized], eax
    jmp endif70
else71:
endif70:
gc_destroy_return:
    mov esp, ebp
    pop ebp
    ret
