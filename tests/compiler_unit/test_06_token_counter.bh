# Test 06: Simple Token Counter
# Tests: Complex control flow with nested loops and breaks
# Expected output: 5
# (For "x = 1 + 2" we expect 5 tokens: x, =, 1, +, 2)
from lib.syscalls import *

class SimpleLexer:
    source: Ptr[uint8]
    pos: int32
    length: int32

def SimpleLexer_init(self: Ptr[SimpleLexer], src: Ptr[uint8]):
    self.source = src
    self.pos = 0
    self.length = strlen(src)

def SimpleLexer_current_char(self: Ptr[SimpleLexer]) -> int32:
    if self.pos >= self.length:
        return 0
    return cast[int32](self.source[self.pos])

def SimpleLexer_advance(self: Ptr[SimpleLexer]):
    self.pos = self.pos + 1

def SimpleLexer_skip_whitespace(self: Ptr[SimpleLexer]):
    while self.pos < self.length:
        ch: int32 = SimpleLexer_current_char(self)
        if ch != 32:  # space
            if ch != 9:  # tab
                break
        SimpleLexer_advance(self)

def SimpleLexer_count_tokens(self: Ptr[SimpleLexer]) -> int32:
    count: int32 = 0
    while self.pos < self.length:
        SimpleLexer_skip_whitespace(self)
        if self.pos >= self.length:
            break
        ch: int32 = SimpleLexer_current_char(self)
        if ch == 0:
            break
        # Skip any non-whitespace as a token
        while self.pos < self.length:
            ch = SimpleLexer_current_char(self)
            if ch == 32:
                break
            if ch == 9:
                break
            if ch == 0:
                break
            SimpleLexer_advance(self)
        count = count + 1
    return count

def main() -> int32:
    lexer: SimpleLexer
    SimpleLexer_init(addr(lexer), "x = 1 + 2")
    count: int32 = SimpleLexer_count_tokens(addr(lexer))
    print_int(count)
    println("")
    return 0
