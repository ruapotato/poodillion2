# Test 29: Direct mmap test
extern def syscall6(num: int32, arg1: int32, arg2: int32, arg3: int32, arg4: int32, arg5: int32, arg6: int32) -> int32
extern def syscall3(num: int32, arg1: int32, arg2: int32, arg3: int32) -> int32

def main():
    print("Testing mmap2 syscall\n")

    # mmap2 syscall: 192
    # addr=0, len=4096, prot=3 (R|W), flags=34 (PRIVATE|ANON), fd=-1, offset=0
    result: int32 = syscall6(192, 0, 4096, 3, 34, -1, 0)

    print("Result: ")
    # Print as decimal
    if result < 0:
        print("-")
        result = 0 - result

    # Simple int print
    if result == 0:
        print("0")
    else:
        buf: int32 = 0
        temp: int32 = result
        digits: int32 = 0
        while temp > 0:
            buf = buf * 10 + (temp % 10)
            temp = temp / 10
            digits = digits + 1
        while digits > 0:
            d: int32 = 48 + (buf % 10)
            syscall3(4, 1, addr(d), 1)
            buf = buf / 10
            digits = digits - 1
    print("\n")

    result = syscall6(192, 0, 4096, 3, 34, -1, 0)
    # mmap errors are in range 0xFFFFF001-0xFFFFFFFF
    # Valid addresses can be > 0x7FFFFFFF, so use unsigned comparison
    uresult: uint32 = cast[uint32](result)
    if uresult > 0xFFFFF000:
        print("FAILED (mmap error)\n")
    else:
        print("SUCCESS (valid address)\n")
