#!/usr/bin/pooscript
# ssh - SSH client for connecting to remote systems

if len(args) == 0:
    error("usage: ssh [user@]host")
    exit(1)

# Get network interface
net = process.get_network()
if not net:
    error("ssh: Network is unreachable")
    exit(1)

target = args[0]

# Parse user@host
if '@' in target:
    parts = target.split('@', 1)
    username = parts[0]
    hostname = parts[1]
else:
    username = 'root'
    hostname = target

# Check if host is reachable
if not net.can_reach(hostname):
    print(f"ssh: connect to host {hostname} port 22: No route to host")
    exit(1)

# Write SSH request to special file for play.py to handle
# Format: username|hostname
ssh_request = f"{username}|{hostname}\n"

# Create or overwrite the SSH request file
try:
    # Try to write to existing file
    vfs.write_bytes('/tmp/.ssh_request', ssh_request.encode())
except:
    # File doesn't exist, create it
    vfs.create('/tmp/.ssh_request', 0o644, ssh_request)

print(f"Connecting to {hostname}...")
# Exit with special code 255 to signal SSH request to shell
exit(255)
