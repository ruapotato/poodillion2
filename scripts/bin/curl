#!/usr/bin/pooscript
# curl - transfer data from URLs

if len(args) == 0:
    error("curl: no URL specified!")
    print("Usage: curl <url>")
    print("")
    print("Examples:")
    print("  curl http://bbs.cyberspace.net/")
    print("  curl news.poo")
    print("  curl cybermart.com/")
    exit(1)

url = args[0]

# Get network interface (for remote requests)
net = process.get_network()

# Parse URL
hostname = None
url_path = "/"

if url.startswith('http://'):
    # Full URL: http://hostname/path
    url = url[7:]
    if '/' in url:
        hostname, url_path = url.split('/', 1)
        url_path = '/' + url_path
    else:
        hostname = url
        url_path = '/'
elif url.startswith('https://'):
    error("curl: HTTPS not supported (this is 1990!)")
    exit(1)
else:
    # Check if it looks like a local file (e.g., news.poo) or a hostname
    if '/' in url:
        # Hostname/path format
        hostname, url_path = url.split('/', 1)
        url_path = '/' + url_path
    elif '.' in url and not url.endswith('.poo') and not url.endswith('.html'):
        # Looks like a hostname (e.g., cybermart.com)
        hostname = url
        url_path = '/'
    else:
        # Local file (e.g., news.poo)
        hostname = None

# If hostname specified, try remote fetch
if hostname and net:
    full_url = f"http://{hostname}{url_path}"
    try:
        content = net.http_get(full_url)
        if content:
            print(content)
            exit(0)
        else:
            error(f"curl: ({hostname}) Failed to fetch content")
            print("Host may be unreachable or file may not exist")
            exit(1)
    except Exception as e:
        error(f"curl: ({hostname}) Connection failed: {e}")
        exit(1)

# Fallback: try local filesystem
local_url = url
if local_url.startswith('http://'):
    local_url = local_url[7:]
if local_url.startswith('https://'):
    local_url = local_url[8:]
local_url = local_url.rstrip('/')

www_path = f"/www/{local_url}"

# Check if the file exists
if vfs.exists(www_path):
    try:
        content = vfs.read(www_path)
        print(content)
        exit(0)
    except RuntimeError as e:
        error(f"curl: Failed to read {www_path}")
        exit(1)

# Try common variations
if not local_url.endswith('.poo') and not local_url.endswith('.html'):
    # Try adding .poo extension
    www_path_poo = f"/www/{local_url}.poo"
    if vfs.exists(www_path_poo):
        try:
            content = vfs.read(www_path_poo)
            print(content)
            exit(0)
        except RuntimeError:
            pass

    # Try adding .html extension
    www_path_html = f"/www/{local_url}.html"
    if vfs.exists(www_path_html):
        try:
            content = vfs.read(www_path_html)
            print(content)
            exit(0)
        except RuntimeError:
            pass

# URL not found
error(f"curl: ({url}) Could not resolve host or find file")
print("")
print("Try:")
print("  - Local files: curl news.poo")
print("  - Remote hosts: curl http://bbs.cyberspace.net/")
print("  - Use 'nmap' to scan the network for hosts")
exit(1)
