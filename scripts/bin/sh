#!/usr/bin/virtualscript
# sh - simple shell
# Processes one command at a time, maintaining state in the process

# Get the command line to execute
if len(args) == 0 or args[0] != '-c':
    error("sh: Usage: sh -c 'command'")
    exit(1)

if len(args) < 2:
    error("sh: -c requires an argument")
    exit(1)

# The command to execute
command_line = args[1]

# Trim whitespace
command_line = command_line.strip()

# Empty command
if not command_line:
    exit(0)

# Parse command into parts
parts = command_line.split()
if not parts:
    exit(0)

cmd = parts[0]
cmd_args = parts[1:] if len(parts) > 1 else []

# Handle built-in commands
if cmd == 'cd':
    # Change directory
    if len(cmd_args) == 0:
        # cd with no args goes to HOME
        target = env.get('HOME', '/')
    else:
        target = cmd_args[0]

    try:
        process.chdir(target)
        exit(0)
    except RuntimeError as e:
        error(f"cd: {target}: No such file or directory")
        exit(1)

elif cmd == 'exit':
    # Exit shell
    code = 0
    if len(cmd_args) > 0:
        try:
            code = int(cmd_args[0])
        except:
            code = 1
    exit(code)

elif cmd == 'export':
    # Set environment variable (simplified)
    if len(cmd_args) > 0 and '=' in cmd_args[0]:
        var, value = cmd_args[0].split('=', 1)
        env[var] = value
    exit(0)

else:
    # Execute external command
    exit_code, stdout_str, stderr_str = process.execute(command_line)
    print(stdout_str, end='')
    if stderr_str:
        error(stderr_str, end='')
    exit(exit_code)
