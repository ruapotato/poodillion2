#!/usr/bin/virtualscript
# ls - list directory contents

# Parse options
show_all = '-a' in args
long_format = '-l' in args

# Get paths (filter out options)
paths = [arg for arg in args if not arg.startswith('-')]
if len(paths) == 0:
    paths = ['.']

for path in paths:
    try:
        entries = vfs.listdetail(path)

        # Add . and .. if -a
        if show_all:
            entries.insert(0, {'name': '..', 'is_dir': True})
            entries.insert(0, {'name': '.', 'is_dir': True})

        # Sort by name
        entries.sort(key=lambda e: e['name'])

        if long_format:
            # Long format: type+perms nlink user group size mtime name
            for entry in entries:
                ftype = get_filetype_char(entry['mode'])
                perms = format_mode(entry['mode'])
                nlink = entry.get('nlink', 1)
                uid = entry.get('uid', 0)
                gid = entry.get('gid', 0)
                size = entry.get('size', 0)
                mtime = entry.get('mtime', 0)
                name = entry['name']
                time_str = format_time(mtime)

                print(f"{ftype}{perms} {nlink:2} {uid:8} {gid:8} {size:8} {time_str} {name}")
        else:
            # Simple format: just names
            names = [entry['name'] for entry in entries]
            print('  '.join(names))

    except RuntimeError as e:
        error(f"ls: {path}: No such file or directory")
        exit(1)

exit(0)
