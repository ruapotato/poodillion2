<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poodillion - 1990s Hacking Simulator</title>

    <!-- Windows 95 CSS -->
    <link rel="stylesheet" href="https://unpkg.com/98.css">

    <!-- xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: teal;
            font-family: "MS Sans Serif", sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .desktop {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .window {
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: absolute;
            min-width: 400px;
            min-height: 300px;
            resize: both;
            overflow: hidden;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100vh - 40px) !important;
            resize: none;
        }

        .window.hidden {
            display: none;
        }

        #terminal-window {
            width: 800px;
            height: 600px;
            top: 50px;
            left: 50px;
            z-index: 1;
        }

        #browser-window {
            width: 700px;
            height: 550px;
            top: 80px;
            left: 200px;
            z-index: 2;
            display: none;
        }

        .window-body {
            margin: 0;
            padding: 0;
            background: #000;
            flex: 1;
            overflow: hidden;
        }

        #terminal-container {
            padding: 4px;
            background: #000;
            height: 100%;
        }

        #browser-content {
            padding: 10px;
            background: white;
            color: black;
            font-family: Arial, sans-serif;
            overflow-y: auto;
            flex: 1;
        }

        .title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
            user-select: none;
        }

        .title-bar-text {
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            gap: 1px;
        }

        .status-bar-field {
            padding: 2px 4px;
        }

        .toolbar {
            display: flex;
            gap: 2px;
            padding: 2px;
            background: silver;
            border-bottom: 2px solid #808080;
        }

        .toolbar button {
            min-width: 60px;
        }

        .address-bar {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: silver;
            align-items: center;
        }

        .address-bar label {
            font-weight: bold;
        }

        .address-bar input {
            flex: 1;
            padding: 2px 4px;
        }

        /* Custom xterm.js styling for retro look */
        .xterm {
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            padding: 8px;
            height: 100% !important;
        }

        .xterm-viewport {
            background-color: #000 !important;
        }

        /* Taskbar */
        .taskbar {
            height: 40px;
            background: silver;
            border-top: 2px solid white;
            display: flex;
            align-items: center;
            padding: 2px 4px;
            gap: 4px;
            flex-shrink: 0;
            position: relative;
        }

        .start-button {
            height: 32px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .start-button img {
            width: 20px;
            height: 20px;
        }

        .taskbar-separator {
            width: 2px;
            height: 32px;
            background: #808080;
            margin: 0 4px;
        }

        .taskbar-items {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .taskbar-button {
            padding: 4px 12px;
            min-width: 150px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .taskbar-button.active {
            border-style: inset;
        }

        .taskbar-clock {
            padding: 4px 8px;
            border: 2px inset #dfdfdf;
            font-family: "MS Sans Serif", sans-serif;
            font-size: 11px;
        }

        /* Start Menu */
        .start-menu {
            position: absolute;
            bottom: 40px;
            left: 2px;
            width: 250px;
            background: silver;
            border: 2px solid;
            border-color: white #808080 #808080 white;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 10000;
        }

        .start-menu.open {
            display: block;
        }

        .start-menu-banner {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 4px;
            font-weight: bold;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            float: left;
            height: 100%;
            min-height: 200px;
            display: flex;
            align-items: flex-end;
            font-size: 24px;
            padding: 8px 4px;
        }

        .start-menu-items {
            margin-left: 32px;
            padding: 4px 0;
        }

        .start-menu-item {
            padding: 8px 32px 8px 40px;
            cursor: pointer;
            position: relative;
            background: silver;
            border: none;
            width: 100%;
            text-align: left;
            font-family: "MS Sans Serif", sans-serif;
            font-size: 11px;
        }

        .start-menu-item:hover {
            background: #000080;
            color: white;
        }

        .start-menu-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background-size: contain;
        }

        .start-menu-separator {
            height: 2px;
            background: #808080;
            margin: 2px 4px;
        }

        /* Browser styles */
        #browser-content pre {
            white-space: pre-wrap;
            font-family: monospace;
        }

        #browser-content h1, #browser-content h2, #browser-content h3 {
            color: #000080;
        }

        #browser-content a {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }

        #browser-content a:visited {
            color: purple;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        /* Desktop icons */
        .desktop-icon {
            position: absolute;
            width: 80px;
            text-align: center;
            cursor: pointer;
            padding: 8px;
            user-select: none;
        }

        .desktop-icon:hover {
            background: rgba(0, 0, 128, 0.3);
        }

        .desktop-icon img {
            width: 48px;
            height: 48px;
        }

        .desktop-icon-label {
            color: white;
            text-shadow: 1px 1px 2px black;
            font-size: 11px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="desktop" id="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icon" style="top: 10px; left: 10px;" ondblclick="openTerminal()">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAE5SURBVGiB7ZnBDcIwDEVfxwAswAiMwCawCRuwARuwCWzACIzACrABG8AGXKpGQqJNXCc9VPwrVWqd96Mk/QshhBBCCCGEkD9CAEyAJbADXsAROAMX4GpZ9wDWQGG8fwEWlr4jYNvmsziN4/6o+rz+VWMDCNOe17dYEzDVuE1bfWO+j+ozaLo+Jq5vknjuhmGTuG6duDaJ6/WNe3UP3C2wfp9eqvMHxg7UHajcgcoduP3CgboDlTtQuQOVO1C5Azy+Sdz9xvW/qE8Sf/lXwA5YAWsgq/5RfVZ9Vr1S+wb4kL50Tc/l7L2O/NdQ/BqKX0Pxayh+DSUvonwCWqDPqr8Gg9Vb9S3QWvVW/T3ht2qfWu8TUGr0kSdwMeijTuBoXB91AgeifgA+jXqrPqs+qz6r/h9RQgghhBBC+DQvaY90DCqsXZMAAAAASUVORK5CYII=" alt="Terminal">
            <div class="desktop-icon-label">Terminal</div>
        </div>

        <div class="desktop-icon" style="top: 110px; left: 10px;" ondblclick="openBrowser()">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAHOSURBVGiB7ZnNi8IwEMZ/6ksPehD8gz0IevKgBw/iRfCgePKgB8GTB0UE8ST4Lyh48OBB8OBB0YMeVFARWZ3Z6Wzbdtu0m+7C/qBQ0pnMl6ZpZhIhhBBCCCGEkH8LAEwALIEjgD2ABwAngLe1tgNQAyit9z4A1NZ6awDblnpHANsO+hxOY7u/V33e/6qxAYRpz+rbWxMw1bhNW31jvo/qM2i6PiaujyfuukncOHHNOnFtEte7G/fqAdwtsN6fV5f0D4wdqDtQuQOVO1C5A9d/cKDuQOUOVO5A5Q5w+SZx92vrvaoviaf8K+AI4AxgBmCu+lz1ufVK7QbwIX3pmq7L2Xsd+V+h+FYofhWKX4XiV1HyIsonYAD6rPprMFi9Vd8DvVVv1f8SfqvOqfU+AZVGH3kCV4M+6gROxvVRJ3Ak6gfg26i36nPrc+tz669C8a1QfCsU3wrFt0LxrVB8KxTfCsW3QvGtUPxrUHwrFN8Kxb8GxX8HxX8Hxb8Gxe8GxX8Hxe8Gxe8Gxe8Gxe8Gxe8Gxe8Gxe8Gxe8GxX8HxX8HxX8HxX8HxX8Hxe8Gxb8Gxb8GxX8Hxe8Gxe8GxX8HxX8HxX8HxX8HxX8HxX8HxX8HxbdC8QkhhBBCCCGk1H4AbCB1EhZXV2cAAAAASUVORK5CYII=" alt="Browser">
            <div class="desktop-icon-label">Lynx Browser</div>
        </div>

        <!-- Terminal Window -->
        <div class="window" id="terminal-window">
            <div class="title-bar">
                <div class="title-bar-text">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABJSURBVCiRY/j//z8DKYCJgUTAqGEYGvj/n4H+Bvz/z0B/A/7/Z6C/Af//M9DfgP//GehvwP//DPQ34P9/BgYGhv8E1ZOuAQCAlwMQE7btMwAAAABJRU5ErkJggg==" width="12" height="12" alt="">
                    Terminal - root@kali-box
                </div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize" onclick="minimizeWindow('terminal-window')"></button>
                    <button aria-label="Maximize" onclick="toggleMaximize('terminal-window')"></button>
                    <button aria-label="Close" onclick="closeWindow('terminal-window')"></button>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <button onclick="clearTerminal()">Clear</button>
                <button onclick="openBrowser()">Browser</button>
                <button onclick="showHelp()">Help</button>
            </div>

            <!-- Terminal -->
            <div class="window-body">
                <div id="terminal-container"></div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-bar-field" id="status-connection">Connecting...</div>
                <div class="status-bar-field" id="status-session">Session: {{ session_id[:8] }}...</div>
            </div>
        </div>

        <!-- Browser Window -->
        <div class="window" id="browser-window">
            <div class="title-bar">
                <div class="title-bar-text">
                    üåê Lynx Browser - Text-Based Web Browser
                </div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize" onclick="minimizeWindow('browser-window')"></button>
                    <button aria-label="Maximize" onclick="toggleMaximize('browser-window')"></button>
                    <button aria-label="Close" onclick="closeWindow('browser-window')"></button>
                </div>
            </div>

            <!-- Address Bar -->
            <div class="address-bar">
                <label>URL:</label>
                <input type="text" id="browser-url" placeholder="Enter hostname (e.g., cybermart.com)" />
                <button onclick="browseTo()">Go</button>
                <button onclick="browserBack()">Back</button>
                <button onclick="browserRefresh()">Refresh</button>
            </div>

            <!-- Browser Content -->
            <div class="window-body">
                <div id="browser-content">
                    <div class="loading">
                        <h2>Welcome to Lynx Browser</h2>
                        <p>A text-based web browser for the early internet.</p>
                        <p>Enter a hostname in the address bar above, or type <code>lynx &lt;hostname&gt;</code> in the terminal.</p>
                        <p><strong>Available Sites:</strong></p>
                        <ul>
                            <li><a onclick="browseToSite('cybermart.com')">cybermart.com</a> - CyberMart Shopping</li>
                            <li><a onclick="browseToSite('bbs.cyberspace.net')">bbs.cyberspace.net</a> - CyberSpace BBS</li>
                            <li><a onclick="browseToSite('underground.bbs')">underground.bbs</a> - The Underground</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-bar-field" id="browser-status">Ready</div>
            </div>
        </div>
    </div>

    <!-- Windows 95 Taskbar -->
    <div class="taskbar">
        <button class="start-button" id="start-button" onclick="toggleStartMenu()">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAADCSURBVDiNndM9CsJAEIbhJ4iNhZWVYGMh2Fh4Aw/gDTyBR/AMHsHSm3gDr+ARbKy0sbDQQkEQLPyBkF0YIYtm4YVhZ2b3Y3eGmR/qMcACG9xiGkpfMUQ7FP+BDVo/8BhL1H7gERa/8AhLVH/gEZY/8AhL5H/gCItfYPELLL6BxTeweBGLF7H4L7D4DhbfwOI7WJzBqljrK0aYoBdKX9HBBN1Q/A1maMfQ3TCAOXaY4xT3LfAOcxzwfI2/AEw0MZ4ozC2yAAAAAElFTkSuQmCC" alt="Logo">
            Poodillion
        </button>

        <!-- Start Menu -->
        <div class="start-menu" id="start-menu">
            <div class="start-menu-banner">Poodillion 95</div>
            <div class="start-menu-items">
                <button class="start-menu-item" onclick="openTerminal(); toggleStartMenu();">
                    üñ•Ô∏è Terminal
                </button>
                <button class="start-menu-item" onclick="openBrowser(); toggleStartMenu();">
                    üåê Lynx Browser
                </button>
                <div class="start-menu-separator"></div>
                <button class="start-menu-item" onclick="showAbout(); toggleStartMenu();">
                    ‚ÑπÔ∏è About
                </button>
                <button class="start-menu-item" onclick="showHelp(); toggleStartMenu();">
                    ‚ùì Help
                </button>
            </div>
        </div>

        <div class="taskbar-separator"></div>
        <div class="taskbar-items" id="taskbar-items"></div>
        <div class="taskbar-clock" id="taskbar-clock"></div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- xterm.js -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        // Window management state
        let activeWindow = null;
        let zIndexCounter = 100;
        let windows = {};

        // Initialize terminal
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: '"Courier New", Courier, monospace',
            theme: {
                background: '#000000',
                foreground: '#00ff00',
                cursor: '#00ff00',
                cursorAccent: '#000000',
                black: '#000000',
                red: '#ff0000',
                green: '#00ff00',
                yellow: '#ffff00',
                blue: '#0000ff',
                magenta: '#ff00ff',
                cyan: '#00ffff',
                white: '#ffffff',
                brightBlack: '#808080',
                brightRed: '#ff8080',
                brightGreen: '#80ff80',
                brightYellow: '#ffff80',
                brightBlue: '#8080ff',
                brightMagenta: '#ff80ff',
                brightCyan: '#80ffff',
                brightWhite: '#ffffff'
            },
            convertEol: true  // Convert \n to \r\n automatically
        });

        // Fit addon for responsive terminal
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        // Open terminal in container
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        // Connect to server via Socket.IO
        const socket = io();

        let currentLine = '';

        // Handle connection
        socket.on('connect', function() {
            document.getElementById('status-connection').textContent = 'Connected';
            document.getElementById('status-connection').style.background = '#90EE90';
        });

        socket.on('disconnect', function() {
            document.getElementById('status-connection').textContent = 'Disconnected';
            document.getElementById('status-connection').style.background = '#FFB6C1';
            term.writeln('\r\n\x1b[31mDisconnected from server\x1b[0m');
        });

        // Receive output from server
        socket.on('output', function(data) {
            // Fix newlines - replace \n with \r\n if not already present
            let output = data.data;
            if (!output.includes('\r\n')) {
                output = output.replace(/\n/g, '\r\n');
            }
            term.write(output);
        });

        // Handle terminal input
        term.onData(function(data) {
            // Handle special keys
            if (data === '\r') {
                // Enter key - send command
                term.write('\r\n');
                socket.emit('input', { data: currentLine });
                currentLine = '';
            } else if (data === '\x7F') {
                // Backspace
                if (currentLine.length > 0) {
                    currentLine = currentLine.slice(0, -1);
                    term.write('\b \b');
                }
            } else if (data === '\x03') {
                // Ctrl+C
                term.write('^C\r\n');
                socket.emit('input', { data: '' });
                currentLine = '';
            } else if (data === '\t') {
                // Tab key - send to server for completion
                socket.emit('input', { data: currentLine + '\t' });
                currentLine += '\t';
            } else if (data.charCodeAt(0) < 32 && data !== '\t') {
                // Ignore other control characters except tab
                return;
            } else {
                // Regular character
                currentLine += data;
                term.write(data);
            }
        });

        // Window dragging functionality
        function makeDraggable(windowElement) {
            const titleBar = windowElement.querySelector('.title-bar');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;

            titleBar.addEventListener('mousedown', function(e) {
                if (e.target.closest('.title-bar-controls')) return;

                isDragging = true;
                focusWindow(windowElement);

                initialX = e.clientX - windowElement.offsetLeft;
                initialY = e.clientY - windowElement.offsetTop;
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                windowElement.style.left = currentX + 'px';
                windowElement.style.top = currentY + 'px';
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });

            // Double-click to maximize
            titleBar.addEventListener('dblclick', function(e) {
                if (e.target.closest('.title-bar-controls')) return;
                toggleMaximize(windowElement.id);
            });
        }

        // Window focus
        function focusWindow(windowElement) {
            if (typeof windowElement === 'string') {
                windowElement = document.getElementById(windowElement);
            }

            activeWindow = windowElement;
            windowElement.style.zIndex = ++zIndexCounter;

            updateTaskbar();
        }

        // Window operations
        function openTerminal() {
            const win = document.getElementById('terminal-window');
            win.classList.remove('hidden');
            win.style.display = 'flex';
            focusWindow(win);
            term.focus();
            updateTaskbar();
        }

        function openBrowser() {
            const win = document.getElementById('browser-window');
            win.classList.remove('hidden');
            win.style.display = 'flex';
            focusWindow(win);
            updateTaskbar();
        }

        function minimizeWindow(windowId) {
            const win = document.getElementById(windowId);
            win.classList.add('hidden');
            updateTaskbar();
        }

        function closeWindow(windowId) {
            const win = document.getElementById(windowId);
            win.style.display = 'none';
            win.classList.add('hidden');
            updateTaskbar();
        }

        function toggleMaximize(windowId) {
            const win = document.getElementById(windowId);
            win.classList.toggle('maximized');

            if (windowId === 'terminal-window') {
                setTimeout(() => fitAddon.fit(), 100);
            }
        }

        // Update taskbar with open windows
        function updateTaskbar() {
            const taskbarItems = document.getElementById('taskbar-items');
            taskbarItems.innerHTML = '';

            const windowList = [
                { id: 'terminal-window', title: 'üñ•Ô∏è Terminal', element: document.getElementById('terminal-window') },
                { id: 'browser-window', title: 'üåê Browser', element: document.getElementById('browser-window') }
            ];

            windowList.forEach(win => {
                if (win.element.style.display !== 'none' && !win.element.classList.contains('hidden')) {
                    const btn = document.createElement('button');
                    btn.className = 'taskbar-button';
                    btn.textContent = win.title;
                    btn.onclick = () => {
                        if (win.element.classList.contains('hidden')) {
                            win.element.classList.remove('hidden');
                        }
                        focusWindow(win.element);
                        if (win.id === 'terminal-window') term.focus();
                    };

                    if (activeWindow === win.element) {
                        btn.classList.add('active');
                    }

                    taskbarItems.appendChild(btn);
                }
            });
        }

        // Start Menu
        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.classList.toggle('open');
        }

        // Close start menu when clicking outside
        document.addEventListener('click', function(e) {
            const startMenu = document.getElementById('start-menu');
            const startButton = document.getElementById('start-button');

            if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
                startMenu.classList.remove('open');
            }
        });

        // Update taskbar clock
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('taskbar-clock').textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Toolbar functions
        function clearTerminal() {
            term.clear();
        }

        function showHelp() {
            socket.emit('input', { data: 'help' });
        }

        function showAbout() {
            alert(
                'POODILLION - 1990s Unix Hacking Simulator\n\n' +
                'A web-based terminal hacking game where you explore\n' +
                'a virtual Unix network circa 1990.\n\n' +
                'Everything runs in your browser!\n\n' +
                'Type "help" in the terminal for available commands.'
            );
        }

        // Browser functions
        function browseToSite(hostname) {
            document.getElementById('browser-url').value = hostname;
            browseTo();
        }

        function browseTo() {
            const url = document.getElementById('browser-url').value.trim();
            if (!url) return;

            document.getElementById('browser-status').textContent = `Loading ${url}...`;
            document.getElementById('browser-content').innerHTML = '<div class="loading">Loading...</div>';

            // Request page content via lynx command
            fetch('/api/browse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('browser-content').innerHTML = formatBrowserContent(data.content);
                    document.getElementById('browser-status').textContent = `Loaded: ${url}`;
                } else {
                    document.getElementById('browser-content').innerHTML =
                        `<div class="loading"><h2>Error</h2><p>${data.error || 'Failed to load page'}</p></div>`;
                    document.getElementById('browser-status').textContent = 'Error loading page';
                }
            })
            .catch(error => {
                document.getElementById('browser-content').innerHTML =
                    `<div class="loading"><h2>Error</h2><p>Network error: ${error.message}</p></div>`;
                document.getElementById('browser-status').textContent = 'Error';
            });
        }

        function formatBrowserContent(content) {
            // Convert plain text to HTML with basic formatting
            // Preserve line breaks and add some basic styling
            return '<pre>' + content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
        }

        function browserBack() {
            // Could implement history
            alert('Back button - not yet implemented');
        }

        function browserRefresh() {
            browseTo();
        }

        // Handle Enter key in address bar
        document.getElementById('browser-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                browseTo();
            }
        });

        // Initialize window dragging
        makeDraggable(document.getElementById('terminal-window'));
        makeDraggable(document.getElementById('browser-window'));

        // Focus terminal on load and update taskbar
        term.focus();
        focusWindow('terminal-window');
        updateTaskbar();
    </script>
</body>
</html>
