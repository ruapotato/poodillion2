; Generated by Brainhair Compiler
bits 32

extern syscall1
extern syscall2
extern syscall3

section .data
str_0: db "Mouse demo - move mouse, click to exit", 10, "", 0
str_1: db "/dev/input/mice", 0
str_2: db "Error: Cannot open /dev/input/mice", 10, "", 0
str_3: db "Try: sudo chmod 644 /dev/input/mice", 10, "", 0
str_4: db "/dev/fb0", 0
str_5: db "Error: Cannot open /dev/fb0", 10, "", 0
str_6: db "Error: Cannot get screen info", 10, "", 0
str_7: db "Mouse demo exited", 10, "", 0

section .text
global _start
global get_argc
global get_argv

section .bss
_startup_esp: resd 1

section .text

_start:
    mov [_startup_esp], esp  ; Save initial stack pointer
    call main
    ; Exit with return code from main
    mov ebx, eax  ; Exit code
    mov eax, 1    ; sys_exit
    int 0x80

; get_argc() - returns argument count
get_argc:
    mov eax, [_startup_esp]
    mov eax, [eax]  ; argc is at [esp]
    ret

; get_argv(index) - returns pointer to argument string
get_argv:
    push ebp
    mov ebp, esp
    mov eax, [_startup_esp]
    mov ecx, [ebp+8]  ; index
    lea eax, [eax + 4 + ecx*4]  ; argv[index] = esp + 4 + index*4
    mov eax, [eax]
    pop ebp
    ret
    
print_str:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, 0
    mov [ebp-4], eax
while_start0:
    mov eax, [ebp-4]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end1
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start0
while_end1:
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
print_str_return:
    mov esp, ebp
    pop ebp
    ret
    
draw_pixel:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, [ebp+12]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp+24]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    mov ebx, eax
    pop eax
    test eax, eax
    jz and_short4
    test ebx, ebx
    jz and_short4
    mov eax, 1
    jmp and_end5
and_short4:
    xor eax, eax
and_end5:
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    mov ebx, eax
    pop eax
    test eax, eax
    jz and_short6
    test ebx, ebx
    jz and_short6
    mov eax, 1
    jmp and_end7
and_short6:
    xor eax, eax
and_end7:
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp+28]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    mov ebx, eax
    pop eax
    test eax, eax
    jz and_short8
    test ebx, ebx
    jz and_short8
    mov eax, 1
    jmp and_end9
and_short8:
    xor eax, eax
and_end9:
    test eax, eax
    jz else3
    mov eax, [ebp+20]
    push eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp+32]
    shl ebx, 2
    add eax, ebx
    pop ebx
    mov [eax], ebx
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp+24]
    mov ebx, eax
    pop eax
    imul eax, ebx
    push eax
    mov eax, [ebp+12]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov [ebp-4], eax
    mov eax, 0
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 19
    push eax
    call syscall3
    add esp, 16
    mov eax, 4
    push eax
    mov eax, [ebp+32]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    jmp endif2
else3:
endif2:
draw_pixel_return:
    mov esp, ebp
    pop ebp
    ret
    
draw_cursor:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, 0
    mov [ebp-4], eax
while_start10:
    mov eax, [ebp-4]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end11
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp-4]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else13
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    jmp endif12
else13:
endif12:
    mov eax, 1
    mov [ebp-8], eax
while_start14:
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 7
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    mov ebx, eax
    pop eax
    test eax, eax
    jz and_short16
    test ebx, ebx
    jz and_short16
    mov eax, 1
    jmp and_end17
and_short16:
    xor eax, eax
and_end17:
    test eax, eax
    jz while_end15
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 0
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    jmp while_start14
while_end15:
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start10
while_end11:
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, 9
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 3
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 16777215
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, 11
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
draw_cursor_return:
    mov esp, ebp
    pop ebp
    ret
    
erase_cursor:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, 0
    mov [ebp-4], eax
while_start18:
    mov eax, [ebp-4]
    push eax
    mov eax, 12
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end19
    mov eax, 0
    mov [ebp-8], eax
while_start20:
    mov eax, [ebp-8]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end21
    mov eax, [ebp+32]
    push eax
    mov eax, [ebp+28]
    push eax
    mov eax, [ebp+24]
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    jmp while_start20
while_end21:
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start18
while_end19:
erase_cursor_return:
    mov esp, ebp
    pop ebp
    ret
    
main:
    push ebp
    mov ebp, esp
    sub esp, 80
    lea eax, [rel str_0]
    push eax
    call print_str
    add esp, 4
    mov eax, 0
    push eax
    lea eax, [rel str_1]
    push eax
    mov eax, 5
    push eax
    call syscall2
    add esp, 12
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else23
    lea eax, [rel str_2]
    push eax
    call print_str
    add esp, 4
    lea eax, [rel str_3]
    push eax
    call print_str
    add esp, 4
    mov eax, 1
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
    jmp endif22
else23:
endif22:
    mov eax, 2
    push eax
    lea eax, [rel str_4]
    push eax
    mov eax, 5
    push eax
    call syscall2
    add esp, 12
    mov [ebp-8], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else25
    lea eax, [rel str_5]
    push eax
    call print_str
    add esp, 4
    mov eax, [ebp-4]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
    jmp endif24
else25:
endif24:
    mov eax, 0
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov [ebp-12], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 4096
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-16], eax
    mov eax, [ebp-16]
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-12]
    mov [ebp-20], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 256
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-24], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 512
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-28], eax
    mov eax, [ebp-20]
    push eax
    mov eax, 17920
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 54
    push eax
    call syscall3
    add esp, 16
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else27
    lea eax, [rel str_6]
    push eax
    call print_str
    add esp, 4
    mov eax, [ebp-8]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-4]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
    jmp endif26
else27:
endif26:
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-36], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-20]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-40], eax
    mov eax, 8256
    mov [ebp-44], eax
    mov eax, [ebp-36]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    xor edx, edx
    idiv ebx
    mov [ebp-48], eax
    mov eax, [ebp-40]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    xor edx, edx
    idiv ebx
    mov [ebp-52], eax
    mov eax, 0
    mov [ebp-56], eax
while_start28:
    mov eax, [ebp-56]
    push eax
    mov eax, [ebp-40]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end29
    mov eax, 0
    mov [ebp-60], eax
while_start30:
    mov eax, [ebp-60]
    push eax
    mov eax, [ebp-36]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end31
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-40]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, [ebp-44]
    push eax
    mov eax, [ebp-56]
    push eax
    mov eax, [ebp-60]
    push eax
    mov eax, [ebp-8]
    push eax
    call draw_pixel
    add esp, 28
    mov eax, [ebp-60]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-60], eax
    jmp while_start30
while_end31:
    mov eax, [ebp-56]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-56], eax
    jmp while_start28
while_end29:
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-40]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, [ebp-52]
    push eax
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-8]
    push eax
    call draw_cursor
    add esp, 24
    mov eax, 1
    mov [ebp-64], eax
while_start32:
    mov eax, [ebp-64]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end33
    mov eax, 3
    push eax
    mov eax, [ebp-28]
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-68], eax
    mov eax, [ebp-68]
    push eax
    mov eax, 3
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else35
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-28]
    add eax, ebx
    movzx eax, byte [eax]
    mov [ebp-72], eax
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp-28]
    add eax, ebx
    movzx eax, byte [eax]
    mov [ebp-76], eax
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp-28]
    add eax, ebx
    movzx eax, byte [eax]
    mov [ebp-80], eax
    mov eax, [ebp-72]
    push eax
    mov eax, 16
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else37
    mov eax, [ebp-76]
    push eax
    mov eax, 256
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-76], eax
    jmp endif36
else37:
endif36:
    mov eax, [ebp-72]
    push eax
    mov eax, 32
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else39
    mov eax, [ebp-80]
    push eax
    mov eax, 256
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-80], eax
    jmp endif38
else39:
endif38:
    mov eax, [ebp-72]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    and eax, ebx
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else41
    mov eax, 0
    mov [ebp-64], eax
    jmp endif40
else41:
endif40:
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-40]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, [ebp-44]
    push eax
    mov eax, [ebp-52]
    push eax
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-8]
    push eax
    call erase_cursor
    add esp, 28
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-76]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-48], eax
    mov eax, [ebp-52]
    push eax
    mov eax, [ebp-80]
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-52], eax
    mov eax, [ebp-48]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else43
    mov eax, 0
    mov [ebp-48], eax
    jmp endif42
else43:
endif42:
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else45
    mov eax, [ebp-36]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    sub eax, ebx
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-48], eax
    jmp endif44
else45:
endif44:
    mov eax, [ebp-52]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else47
    mov eax, 0
    mov [ebp-52], eax
    jmp endif46
else47:
endif46:
    mov eax, [ebp-52]
    push eax
    mov eax, [ebp-40]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else49
    mov eax, [ebp-40]
    push eax
    mov eax, 12
    mov ebx, eax
    pop eax
    sub eax, ebx
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-52], eax
    jmp endif48
else49:
endif48:
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-40]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, [ebp-52]
    push eax
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-8]
    push eax
    call draw_cursor
    add esp, 24
    jmp endif34
else35:
endif34:
    jmp while_start32
while_end33:
    mov eax, [ebp-8]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-4]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    lea eax, [rel str_7]
    push eax
    call print_str
    add esp, 4
    mov eax, 0
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
main_return:
    mov esp, ebp
    pop ebp
    ret