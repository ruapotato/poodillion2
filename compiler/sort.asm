; Generated by Mini-Nim Compiler
bits 32

extern syscall1
extern syscall3

section .data
str_0: db "Error: No schema header", 10, "", 0

section .text
global _start
global get_argc
global get_argv

section .bss
_startup_esp: resd 1

section .text

_start:
    mov [_startup_esp], esp  ; Save initial stack pointer
    call main
    ; Halt (infinite loop)
.halt:
    hlt
    jmp .halt

; get_argc() - returns argument count
get_argc:
    mov eax, [_startup_esp]
    mov eax, [eax]  ; argc is at [esp]
    ret

; get_argv(index) - returns pointer to argument string
get_argv:
    push ebp
    mov ebp, esp
    mov eax, [_startup_esp]
    mov ecx, [ebp+8]  ; index
    lea eax, [eax + 4 + ecx*4]  ; argv[index] = esp + 4 + index*4
    mov eax, [eax]
    pop ebp
    ret
    
strlen:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, 0
    mov [ebp-4], eax
while_start0:
    mov eax, [ebp-4]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end1
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start0
while_end1:
    mov eax, [ebp-4]
    jmp strlen_return
strlen_return:
    mov esp, ebp
    pop ebp
    ret
    
print_err:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, [ebp+8]
    push eax
    call strlen
    add esp, 4
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 2
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
print_err_return:
    mov esp, ebp
    pop ebp
    ret
    
parse_int:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, 0
    mov [ebp-4], eax
    mov eax, 0
    mov [ebp-8], eax
while_start2:
    mov eax, [ebp-8]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 48
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz while_end3
    mov eax, [ebp-8]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 57
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    test eax, eax
    jz else5
    jmp while_end3
    jmp endif4
else5:
endif4:
    mov eax, [ebp-4]
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    imul eax, ebx
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 48
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-4], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    jmp while_start2
while_end3:
    mov eax, [ebp-4]
    jmp parse_int_return
parse_int_return:
    mov esp, ebp
    pop ebp
    ret
    
is_desc:
    push ebp
    mov ebp, esp
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 100
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else7
    mov eax, 1
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 101
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else9
    mov eax, 2
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 115
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else11
    mov eax, 3
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 99
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else13
    mov eax, 1
    jmp is_desc_return
    jmp endif12
else13:
endif12:
    jmp endif10
else11:
endif10:
    jmp endif8
else9:
endif8:
    jmp endif6
else7:
endif6:
    mov eax, 0
    jmp is_desc_return
is_desc_return:
    mov esp, ebp
    pop ebp
    ret
    
swap_records:
    push ebp
    mov ebp, esp
    sub esp, 13
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp+20]
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov [ebp-4], eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp+20]
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov [ebp-8], eax
    mov eax, 0
    mov [ebp-12], eax
while_start14:
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp+20]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end15
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp-12]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    mov byte [ebp-13], al
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp-12]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp-12]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    movzx eax, byte [ebp-13]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp-12]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp-12]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-12], eax
    jmp while_start14
while_end15:
swap_records_return:
    mov esp, ebp
    pop ebp
    ret
    
get_field:
    push ebp
    mov ebp, esp
    sub esp, 8
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp+16]
    mov ebx, eax
    pop eax
    imul eax, ebx
    push eax
    mov eax, [ebp+20]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    mov eax, [ebp+8]
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-8]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    jmp get_field_return
get_field_return:
    mov esp, ebp
    pop ebp
    ret
    
bubble_sort:
    push ebp
    mov ebp, esp
    sub esp, 20
    mov eax, 0
    mov [ebp-4], eax
while_start16:
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end17
    mov eax, 0
    mov [ebp-8], eax
while_start18:
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    push eax
    mov eax, [ebp-4]
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end19
    mov eax, [ebp+20]
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp+8]
    push eax
    call get_field
    add esp, 16
    mov [ebp-12], eax
    mov eax, [ebp+20]
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp+8]
    push eax
    call get_field
    add esp, 16
    mov [ebp-16], eax
    mov eax, 0
    mov [ebp-20], eax
    mov eax, [ebp+24]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else21
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp-16]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else23
    mov eax, 1
    mov [ebp-20], eax
    jmp endif22
else23:
endif22:
    jmp endif20
else21:
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp-16]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    test eax, eax
    jz else25
    mov eax, 1
    mov [ebp-20], eax
    jmp endif24
else25:
endif24:
endif20:
    mov eax, [ebp-20]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else27
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp+8]
    push eax
    call swap_records
    add esp, 16
    jmp endif26
else27:
endif26:
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    jmp while_start18
while_end19:
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start16
while_end17:
bubble_sort_return:
    mov esp, ebp
    pop ebp
    ret
    
main:
    push ebp
    mov ebp, esp
    sub esp, 64
    call get_argc
    mov [ebp-4], eax
    mov eax, 0
    mov [ebp-8], eax
    mov eax, 0
    mov [ebp-12], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else29
    mov eax, 1
    push eax
    call get_argv
    add esp, 4
    mov [ebp-16], eax
    mov eax, [ebp-16]
    push eax
    call parse_int
    add esp, 4
    mov [ebp-8], eax
    jmp endif28
else29:
endif28:
    mov eax, [ebp-4]
    push eax
    mov eax, 3
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else31
    mov eax, 2
    push eax
    call get_argv
    add esp, 4
    mov [ebp-20], eax
    mov eax, [ebp-20]
    push eax
    call is_desc
    add esp, 4
    mov [ebp-12], eax
    jmp endif30
else31:
endif30:
    mov eax, 0
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov [ebp-24], eax
    mov eax, [ebp-24]
    push eax
    mov eax, 262144
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-24]
    mov [ebp-32], eax
    mov eax, [ebp-24]
    push eax
    mov eax, 64
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-36], eax
    mov eax, 8
    push eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-40], eax
    mov eax, [ebp-40]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else33
    lea eax, [rel str_0]
    push eax
    call print_err
    add esp, 4
    mov eax, 1
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
    jmp endif32
else33:
endif32:
    mov eax, [ebp-32]
    push eax
    mov eax, 6
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-44], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-44]
    shl ebx, 1
    add eax, ebx
    movzx eax, word [eax]
    mov [ebp-48], eax
    mov eax, 4
    push eax
    mov eax, [ebp-32]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 0
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-40], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-52], eax
    mov eax, 0
    mov ebx, eax
    mov eax, [ebp-52]
    shl ebx, 2
    add eax, ebx
    mov eax, [eax]
    mov [ebp-56], eax
    mov eax, [ebp-56]
    push eax
    mov eax, [ebp-48]
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov [ebp-60], eax
    mov eax, 0
    mov [ebp-64], eax
while_start34:
    mov eax, [ebp-64]
    push eax
    mov eax, [ebp-60]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end35
    mov eax, [ebp-60]
    push eax
    mov eax, [ebp-64]
    mov ebx, eax
    pop eax
    sub eax, ebx
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, [ebp-64]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 0
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-40], eax
    mov eax, [ebp-40]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setle al
    movzx eax, al
    test eax, eax
    jz else37
    jmp while_end35
    jmp endif36
else37:
endif36:
    mov eax, [ebp-64]
    push eax
    mov eax, [ebp-40]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-64], eax
    jmp while_start34
while_end35:
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-56]
    push eax
    mov eax, [ebp-36]
    push eax
    call bubble_sort
    add esp, 20
    mov eax, 8
    push eax
    mov eax, [ebp-32]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    mov eax, 4
    push eax
    mov eax, [ebp-32]
    push eax
    mov eax, 8
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    mov eax, [ebp-64]
    push eax
    mov eax, [ebp-36]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    mov eax, 0
    push eax
    mov eax, 1
    push eax
    call syscall1
    add esp, 8
main_return:
    mov esp, ebp
    pop ebp
    ret
