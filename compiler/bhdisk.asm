; Generated by Brainhair Compiler
bits 32

extern syscall1
extern syscall2
extern syscall3

section .data
str_0: db "", 10, "", 0
str_1: db "bhdisk: cannot open ", 0
str_2: db "", 10, "", 0
str_3: db "bhdisk - Brainhair Disk Image Creator", 0
str_4: db "Usage: bhdisk <output.img> [stage1] [stage2] [kernel]", 0
str_5: db "", 0
str_6: db "Creates a bootable disk image with:", 0
str_7: db "  Sector 0:     Stage 1 bootloader (512 bytes)", 0
str_8: db "  Sectors 1-17: Stage 2 bootloader", 0
str_9: db "  Sector 18+:   Kernel", 0
str_10: db "build/stage1.bin", 0
str_11: db "build/stage2.bin", 0
str_12: db "build/kernel.bin", 0
str_13: db "  Creating disk image: ", 0
str_14: db "bhdisk: cannot create ", 0
str_15: db "", 10, "", 0
str_16: db "  Allocating 10MB...", 0
str_17: db " failed", 10, "", 0
str_18: db " done", 0
str_19: db "  Writing Stage 1 (", 0
str_20: db ")...", 0
str_21: db " bytes", 0
str_22: db "  Writing Stage 2 (", 0
str_23: db ")...", 0
str_24: db " bytes", 0
str_25: db "  Writing Kernel (", 0
str_26: db ")...", 0
str_27: db " bytes", 0
str_28: db "", 0
str_29: db "Disk image created: ", 0

section .text
global _start
global get_argc
global get_argv

section .bss
_startup_esp: resd 1

section .text

_start:
    mov [_startup_esp], esp  ; Save initial stack pointer
    call main
    ; Exit with return code from main
    mov ebx, eax  ; Exit code
    mov eax, 1    ; sys_exit
    int 0x80

; get_argc() - returns argument count
get_argc:
    mov eax, [_startup_esp]
    mov eax, [eax]  ; argc is at [esp]
    ret

; get_argv(index) - returns pointer to argument string
get_argv:
    push ebp
    mov ebp, esp
    mov eax, [_startup_esp]
    mov ecx, [ebp+8]  ; index
    lea eax, [eax + 4 + ecx*4]  ; argv[index] = esp + 4 + index*4
    mov eax, [eax]
    pop ebp
    ret
    
print:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, 0
    mov [ebp-4], eax
while_start0:
    mov eax, [ebp-4]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end1
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start0
while_end1:
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
print_return:
    mov esp, ebp
    pop ebp
    ret
    
println:
    push ebp
    mov ebp, esp
    mov eax, [ebp+8]
    push eax
    call print
    add esp, 4
    mov eax, 1
    push eax
    lea eax, [rel str_0]
    push eax
    mov eax, 1
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
println_return:
    mov esp, ebp
    pop ebp
    ret
    
print_err:
    push ebp
    mov ebp, esp
    sub esp, 4
    mov eax, 0
    mov [ebp-4], eax
while_start2:
    mov eax, [ebp-4]
    mov ebx, eax
    mov eax, [ebp+8]
    add eax, ebx
    movzx eax, byte [eax]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz while_end3
    mov eax, [ebp-4]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-4], eax
    jmp while_start2
while_end3:
    mov eax, [ebp-4]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 2
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
print_err_return:
    mov esp, ebp
    pop ebp
    ret
    
print_num:
    push ebp
    mov ebp, esp
    sub esp, 12
    mov eax, 10
    mov [ebp-8], eax
    mov eax, 0
    push eax
    mov eax, 11
    mov ebx, eax
    mov eax, [ebp-4]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp+8]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    sete al
    movzx eax, al
    test eax, eax
    jz else5
    mov eax, 48
    push eax
    mov eax, 10
    mov ebx, eax
    mov eax, [ebp-4]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, 10
    mov [ebp-8], eax
    jmp endif4
else5:
    mov eax, [ebp+8]
    mov [ebp-12], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else7
    mov eax, 0
    push eax
    mov eax, [ebp-12]
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-12], eax
    jmp endif6
else7:
endif6:
while_start8:
    mov eax, [ebp-12]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    mov ebx, eax
    pop eax
    test eax, eax
    jz and_short10
    test ebx, ebx
    jz and_short10
    mov eax, 1
    jmp and_end11
and_short10:
    xor eax, eax
and_end11:
    test eax, eax
    jz while_end9
    mov eax, 48
    push eax
    mov eax, [ebp-12]
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    xor edx, edx
    idiv ebx
    mov eax, edx
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    mov eax, [ebp-4]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp-12]
    push eax
    mov eax, 10
    mov ebx, eax
    pop eax
    xor edx, edx
    idiv ebx
    mov [ebp-12], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-8], eax
    jmp while_start8
while_end9:
    mov eax, [ebp-8]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
endif4:
    lea eax, [ebp-4]
    push eax
    mov eax, [ebp-8]
    mov ebx, eax
    pop eax
    add eax, ebx
    push eax
    call print
    add esp, 4
print_num_return:
    mov esp, ebp
    pop ebp
    ret
    
write_zeros:
    push ebp
    mov ebp, esp
    sub esp, 28
    mov eax, 0
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 4096
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-8], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-4]
    mov [ebp-12], eax
    mov eax, 0
    mov [ebp-16], eax
while_start12:
    mov eax, [ebp-16]
    push eax
    mov eax, 4096
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end13
    mov eax, 0
    push eax
    mov eax, [ebp-16]
    mov ebx, eax
    mov eax, [ebp-12]
    add eax, ebx
    pop ebx
    mov byte [eax], bl
    mov eax, [ebp-16]
    push eax
    mov eax, 1
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-16], eax
    jmp while_start12
while_end13:
    mov eax, 0
    mov [ebp-20], eax
while_start14:
    mov eax, [ebp-20]
    push eax
    mov eax, [ebp+12]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz while_end15
    mov eax, [ebp+12]
    push eax
    mov eax, [ebp-20]
    mov ebx, eax
    pop eax
    sub eax, ebx
    mov [ebp-24], eax
    mov eax, [ebp-24]
    push eax
    mov eax, 4096
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    test eax, eax
    jz else17
    mov eax, 4096
    mov [ebp-24], eax
    jmp endif16
else17:
endif16:
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setle al
    movzx eax, al
    test eax, eax
    jz else19
    mov eax, 1
    neg eax
    jmp write_zeros_return
    jmp endif18
else19:
endif18:
    mov eax, [ebp-20]
    push eax
    mov eax, [ebp-28]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-20], eax
    jmp while_start14
while_end15:
    mov eax, [ebp-20]
    jmp write_zeros_return
write_zeros_return:
    mov esp, ebp
    pop ebp
    ret
    
copy_file_to_disk:
    push ebp
    mov ebp, esp
    sub esp, 28
    mov eax, 0
    push eax
    mov eax, 0
    push eax
    mov eax, [ebp+12]
    push eax
    mov eax, 5
    push eax
    call syscall3
    add esp, 16
    mov [ebp-4], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else21
    lea eax, [rel str_1]
    push eax
    call print_err
    add esp, 4
    mov eax, [ebp+12]
    push eax
    call print_err
    add esp, 4
    lea eax, [rel str_2]
    push eax
    call print_err
    add esp, 4
    mov eax, 1
    neg eax
    jmp copy_file_to_disk_return
    jmp endif20
else21:
endif20:
    mov eax, 0
    push eax
    mov eax, [ebp+16]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 19
    push eax
    call syscall3
    add esp, 16
    mov eax, 0
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov [ebp-8], eax
    mov eax, [ebp-8]
    push eax
    mov eax, 8192
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-12], eax
    mov eax, [ebp-12]
    push eax
    mov eax, 45
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-8]
    mov [ebp-16], eax
    mov eax, 0
    mov [ebp-20], eax
    mov eax, 8192
    push eax
    mov eax, [ebp-16]
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-24], eax
while_start22:
    mov eax, [ebp-24]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setg al
    movzx eax, al
    test eax, eax
    jz while_end23
    mov eax, [ebp-24]
    push eax
    mov eax, [ebp-16]
    push eax
    mov eax, [ebp+8]
    push eax
    mov eax, 4
    push eax
    call syscall3
    add esp, 16
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    mov eax, [ebp-24]
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setne al
    movzx eax, al
    test eax, eax
    jz else25
    mov eax, [ebp-4]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    neg eax
    jmp copy_file_to_disk_return
    jmp endif24
else25:
endif24:
    mov eax, [ebp-20]
    push eax
    mov eax, [ebp-24]
    mov ebx, eax
    pop eax
    add eax, ebx
    mov [ebp-20], eax
    mov eax, 8192
    push eax
    mov eax, [ebp-16]
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, 3
    push eax
    call syscall3
    add esp, 16
    mov [ebp-24], eax
    jmp while_start22
while_end23:
    mov eax, [ebp-4]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, [ebp-20]
    jmp copy_file_to_disk_return
copy_file_to_disk_return:
    mov esp, ebp
    pop ebp
    ret
    
main:
    push ebp
    mov ebp, esp
    sub esp, 32
    call get_argc
    mov [ebp-4], eax
    lea eax, [rel str_3]
    push eax
    call println
    add esp, 4
    mov eax, [ebp-4]
    push eax
    mov eax, 2
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else27
    lea eax, [rel str_4]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_5]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_6]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_7]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_8]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_9]
    push eax
    call println
    add esp, 4
    mov eax, 1
    jmp main_return
    jmp endif26
else27:
endif26:
    mov eax, 1
    push eax
    call get_argv
    add esp, 4
    mov [ebp-8], eax
    lea eax, [rel str_10]
    mov [ebp-12], eax
    lea eax, [rel str_11]
    mov [ebp-16], eax
    lea eax, [rel str_12]
    mov [ebp-20], eax
    mov eax, [ebp-4]
    push eax
    mov eax, 3
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else29
    mov eax, 2
    push eax
    call get_argv
    add esp, 4
    mov [ebp-12], eax
    jmp endif28
else29:
endif28:
    mov eax, [ebp-4]
    push eax
    mov eax, 4
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else31
    mov eax, 3
    push eax
    call get_argv
    add esp, 4
    mov [ebp-16], eax
    jmp endif30
else31:
endif30:
    mov eax, [ebp-4]
    push eax
    mov eax, 5
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setge al
    movzx eax, al
    test eax, eax
    jz else33
    mov eax, 4
    push eax
    call get_argv
    add esp, 4
    mov [ebp-20], eax
    jmp endif32
else33:
endif32:
    lea eax, [rel str_13]
    push eax
    call print
    add esp, 4
    mov eax, [ebp-8]
    push eax
    call println
    add esp, 4
    mov eax, 420
    push eax
    mov eax, 1
    push eax
    mov eax, 64
    mov ebx, eax
    pop eax
    or eax, ebx
    push eax
    mov eax, 512
    mov ebx, eax
    pop eax
    or eax, ebx
    push eax
    mov eax, [ebp-8]
    push eax
    mov eax, 5
    push eax
    call syscall3
    add esp, 16
    mov [ebp-24], eax
    mov eax, [ebp-24]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else35
    lea eax, [rel str_14]
    push eax
    call print_err
    add esp, 4
    mov eax, [ebp-8]
    push eax
    call print_err
    add esp, 4
    lea eax, [rel str_15]
    push eax
    call print_err
    add esp, 4
    mov eax, 1
    jmp main_return
    jmp endif34
else35:
endif34:
    lea eax, [rel str_16]
    push eax
    call print
    add esp, 4
    mov eax, 20480
    push eax
    mov eax, 512
    mov ebx, eax
    pop eax
    imul eax, ebx
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    mov eax, [ebp-24]
    push eax
    call write_zeros
    add esp, 8
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else37
    lea eax, [rel str_17]
    push eax
    call print_err
    add esp, 4
    mov eax, [ebp-24]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    jmp main_return
    jmp endif36
else37:
endif36:
    lea eax, [rel str_18]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_19]
    push eax
    call print
    add esp, 4
    mov eax, [ebp-12]
    push eax
    call print
    add esp, 4
    lea eax, [rel str_20]
    push eax
    call print
    add esp, 4
    mov eax, 0
    push eax
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp-24]
    push eax
    call copy_file_to_disk
    add esp, 12
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else39
    mov eax, [ebp-24]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    jmp main_return
    jmp endif38
else39:
endif38:
    mov eax, [ebp-32]
    push eax
    call print_num
    add esp, 4
    lea eax, [rel str_21]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_22]
    push eax
    call print
    add esp, 4
    mov eax, [ebp-16]
    push eax
    call print
    add esp, 4
    lea eax, [rel str_23]
    push eax
    call print
    add esp, 4
    mov eax, 512
    push eax
    mov eax, [ebp-16]
    push eax
    mov eax, [ebp-24]
    push eax
    call copy_file_to_disk
    add esp, 12
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else41
    mov eax, [ebp-24]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    jmp main_return
    jmp endif40
else41:
endif40:
    mov eax, [ebp-32]
    push eax
    call print_num
    add esp, 4
    lea eax, [rel str_24]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_25]
    push eax
    call print
    add esp, 4
    mov eax, [ebp-20]
    push eax
    call print
    add esp, 4
    lea eax, [rel str_26]
    push eax
    call print
    add esp, 4
    mov eax, 18
    push eax
    mov eax, 512
    mov ebx, eax
    pop eax
    imul eax, ebx
    push eax
    mov eax, [ebp-20]
    push eax
    mov eax, [ebp-24]
    push eax
    call copy_file_to_disk
    add esp, 12
    mov [ebp-32], eax
    mov eax, [ebp-32]
    push eax
    mov eax, 0
    mov ebx, eax
    pop eax
    cmp eax, ebx
    setl al
    movzx eax, al
    test eax, eax
    jz else43
    mov eax, [ebp-24]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    mov eax, 1
    jmp main_return
    jmp endif42
else43:
endif42:
    mov eax, [ebp-32]
    push eax
    call print_num
    add esp, 4
    lea eax, [rel str_27]
    push eax
    call println
    add esp, 4
    mov eax, [ebp-24]
    push eax
    mov eax, 6
    push eax
    call syscall1
    add esp, 8
    lea eax, [rel str_28]
    push eax
    call println
    add esp, 4
    lea eax, [rel str_29]
    push eax
    call print
    add esp, 4
    mov eax, [ebp-8]
    push eax
    call println
    add esp, 4
    mov eax, 0
    jmp main_return
main_return:
    mov esp, ebp
    pop ebp
    ret
