# Random library test
from lib.syscalls import write, exit, STDOUT
from lib.random import random_bytes, random_range, random_string, random_shuffle, random_uuid

def print_str(s: Ptr[uint8]):
    len: int32 = 0
    while (s[len] != cast[uint8](0)):
        len = (len + 1)
    write(STDOUT, s, len)

def print_hex_byte(b: uint8):
    hex: Ptr[uint8] = Ptr[uint8]("0123456789abcdef")
    high: uint8 = hex[cast[int32](b) >> 4]
    low: uint8 = hex[cast[int32](b) & 15]
    write(STDOUT, addr(high), 1)
    write(STDOUT, addr(low), 1)

def print_decimal(n: int32):
    if (n == 0):
        print_str(Ptr[uint8]("0"))
        return
    negative: int32 = 0
    if (n < 0):
        negative = 1
        n = (0 - n)
    buf: Array[12, uint8]
    i: int32 = 10
    buf[11] = cast[uint8](0)
    while (n > 0):
        buf[i] = cast[uint8](48 + (n % 10))
        n = (n / 10)
        i = (i - 1)
    if (negative == 1):
        buf[i] = cast[uint8](45)
        i = (i - 1)
    print_str(cast[Ptr[uint8]](cast[int32](addr(buf)) + i + 1))

def main() -> int32:
    print_str(Ptr[uint8]("=== Random Library Test ===\n\n"))

    # Test random_bytes
    print_str(Ptr[uint8]("Testing random_bytes(16): "))
    bytes_buf: Array[16, uint8]
    result: int32 = random_bytes(Ptr[uint8](addr(bytes_buf)), 16)
    if (result == 0):
        i: int32 = 0
        while (i < 16):
            print_hex_byte(bytes_buf[i])
            i = (i + 1)
        print_str(Ptr[uint8]("\n"))
    else:
        print_str(Ptr[uint8]("FAILED\n"))

    # Test random_range
    print_str(Ptr[uint8]("\nTesting random_range(1, 100):\n"))
    i: int32 = 0
    while (i < 5):
        val: int32 = random_range(1, 100)
        print_str(Ptr[uint8]("  "))
        print_decimal(val)
        print_str(Ptr[uint8]("\n"))
        i = (i + 1)

    # Test random_string
    print_str(Ptr[uint8]("\nTesting random_string(16): "))
    str_buf: Array[32, uint8]
    result = random_string(Ptr[uint8](addr(str_buf)), 16)
    if (result == 0):
        print_str(Ptr[uint8](addr(str_buf)))
        print_str(Ptr[uint8]("\n"))
    else:
        print_str(Ptr[uint8]("FAILED\n"))

    # Test uuid4
    print_str(Ptr[uint8]("\nTesting random_uuid():\n"))
    uuid_buf: Array[40, uint8]
    i = 0
    while (i < 3):
        result = random_uuid(Ptr[uint8](addr(uuid_buf)))
        if (result == 0):
            print_str(Ptr[uint8]("  "))
            print_str(Ptr[uint8](addr(uuid_buf)))
            print_str(Ptr[uint8]("\n"))
        i = (i + 1)

    print_str(Ptr[uint8]("\n=== Test Complete ===\n"))
    return 0
