from lib.syscalls import write, exit, STDOUT
from lib.aes import *

def print_str(msg: Ptr[uint8]):
    len: int32 = 0
    p: Ptr[uint8] = msg
    while (p[len] != cast[uint8](0)):
        len = (len + 1)
    write(STDOUT, msg, len)

def print_hex_byte(b: uint8):
    hex: Array[3, uint8]
    nibble_high: int32 = (cast[int32](b) >> 4)
    nibble_low: int32 = (cast[int32](b) & 15)
    if (nibble_high < 10):
        hex[0] = cast[uint8]((48 + nibble_high))
    else:
        hex[0] = cast[uint8](((97 + nibble_high) - 10))
    if (nibble_low < 10):
        hex[1] = cast[uint8]((48 + nibble_low))
    else:
        hex[1] = cast[uint8](((97 + nibble_low) - 10))
    hex[2] = cast[uint8](0)
    print_str(Ptr[uint8](addr(hex)))

def print_hex_buffer(buf: Ptr[uint8], len: int32):
    i: int32 = 0
    while (i < len):
        print_hex_byte(buf[i])
        if (i < (len - 1)):
            print_str(Ptr[uint8](" "))
        i = (i + 1)

def print_block(label: Ptr[uint8], buf: Ptr[uint8], len: int32):
    print_str(label)
    print_str(Ptr[uint8](": "))
    print_hex_buffer(buf, len)
    print_str(Ptr[uint8]("\n"))

def compare_buffers(buf1: Ptr[uint8], buf2: Ptr[uint8], len: int32) -> int32:
    i: int32 = 0
    while (i < len):
        if (buf1[i] != buf2[i]):
            return 0
        i = (i + 1)
    return 1

def test_aes_128():
    print_str(Ptr[uint8]("\n=== AES-128 Test ===\n"))
    key: Array[16, uint8]
    key[0] = cast[uint8](43)
    key[1] = cast[uint8](126)
    key[2] = cast[uint8](21)
    key[3] = cast[uint8](22)
    key[4] = cast[uint8](40)
    key[5] = cast[uint8](174)
    key[6] = cast[uint8](210)
    key[7] = cast[uint8](166)
    key[8] = cast[uint8](171)
    key[9] = cast[uint8](247)
    key[10] = cast[uint8](21)
    key[11] = cast[uint8](136)
    key[12] = cast[uint8](9)
    key[13] = cast[uint8](207)
    key[14] = cast[uint8](79)
    key[15] = cast[uint8](60)
    plaintext: Array[16, uint8]
    plaintext[0] = cast[uint8](50)
    plaintext[1] = cast[uint8](67)
    plaintext[2] = cast[uint8](246)
    plaintext[3] = cast[uint8](168)
    plaintext[4] = cast[uint8](136)
    plaintext[5] = cast[uint8](90)
    plaintext[6] = cast[uint8](48)
    plaintext[7] = cast[uint8](141)
    plaintext[8] = cast[uint8](49)
    plaintext[9] = cast[uint8](49)
    plaintext[10] = cast[uint8](152)
    plaintext[11] = cast[uint8](162)
    plaintext[12] = cast[uint8](224)
    plaintext[13] = cast[uint8](55)
    plaintext[14] = cast[uint8](7)
    plaintext[15] = cast[uint8](52)
    ciphertext: Array[16, uint8]
    decrypted: Array[16, uint8]
    result: int32 = aes_key_init(Ptr[uint8](addr(key)), AES_KEY_SIZE_128)
    if (result != 0):
        print_str(Ptr[uint8]("Error: Failed to initialize AES key\n"))
        return
    print_block(Ptr[uint8]("Key"), Ptr[uint8](addr(key)), 16)
    print_block(Ptr[uint8]("Plaintext"), Ptr[uint8](addr(plaintext)), 16)
    result = aes_encrypt_block(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(ciphertext)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Encryption failed\n"))
        return
    print_block(Ptr[uint8]("Ciphertext"), Ptr[uint8](addr(ciphertext)), 16)
    result = aes_decrypt_block(Ptr[uint8](addr(ciphertext)), Ptr[uint8](addr(decrypted)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Decryption failed\n"))
        return
    print_block(Ptr[uint8]("Decrypted"), Ptr[uint8](addr(decrypted)), 16)
    if (compare_buffers(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(decrypted)), 16) != 0):
        print_str(Ptr[uint8]("✓ AES-128 test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ AES-128 test FAILED\n"))

def test_aes_256():
    print_str(Ptr[uint8]("\n=== AES-256 Test ===\n"))
    key: Array[32, uint8]
    i: int32 = 0
    while (i < 32):
        key[i] = cast[uint8](((i * 7) + 42))
        i = (i + 1)
    plaintext: Array[16, uint8]
    i = 0
    while (i < 16):
        plaintext[i] = cast[uint8]((65 + i))
        i = (i + 1)
    ciphertext: Array[16, uint8]
    decrypted: Array[16, uint8]
    result: int32 = aes_key_init(Ptr[uint8](addr(key)), AES_KEY_SIZE_256)
    if (result != 0):
        print_str(Ptr[uint8]("Error: Failed to initialize AES-256 key\n"))
        return
    print_block(Ptr[uint8]("Key"), Ptr[uint8](addr(key)), 32)
    print_block(Ptr[uint8]("Plaintext"), Ptr[uint8](addr(plaintext)), 16)
    result = aes_encrypt_block(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(ciphertext)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Encryption failed\n"))
        return
    print_block(Ptr[uint8]("Ciphertext"), Ptr[uint8](addr(ciphertext)), 16)
    result = aes_decrypt_block(Ptr[uint8](addr(ciphertext)), Ptr[uint8](addr(decrypted)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Decryption failed\n"))
        return
    print_block(Ptr[uint8]("Decrypted"), Ptr[uint8](addr(decrypted)), 16)
    if (compare_buffers(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(decrypted)), 16) != 0):
        print_str(Ptr[uint8]("✓ AES-256 test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ AES-256 test FAILED\n"))

def test_cbc_mode():
    print_str(Ptr[uint8]("\n=== CBC Mode Test ===\n"))
    key: Array[16, uint8]
    i: int32 = 0
    while (i < 16):
        key[i] = cast[uint8]((i + 1))
        i = (i + 1)
    iv: Array[16, uint8]
    i = 0
    while (i < 16):
        iv[i] = cast[uint8]((16 - i))
        i = (i + 1)
    plaintext: Array[32, uint8]
    i = 0
    while (i < 32):
        plaintext[i] = cast[uint8]((65 + (i % 26)))
        i = (i + 1)
    ciphertext: Array[32, uint8]
    decrypted: Array[32, uint8]
    result: int32 = aes_key_init(Ptr[uint8](addr(key)), AES_KEY_SIZE_128)
    if (result != 0):
        print_str(Ptr[uint8]("Error: Failed to initialize AES key\n"))
        return
    print_block(Ptr[uint8]("IV"), Ptr[uint8](addr(iv)), 16)
    print_block(Ptr[uint8]("Plaintext"), Ptr[uint8](addr(plaintext)), 32)
    result = aes_encrypt_cbc_mode(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(ciphertext)), 32, Ptr[uint8](addr(iv)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: CBC encryption failed\n"))
        return
    print_block(Ptr[uint8]("Ciphertext"), Ptr[uint8](addr(ciphertext)), 32)
    result = aes_decrypt_cbc_mode(Ptr[uint8](addr(ciphertext)), Ptr[uint8](addr(decrypted)), 32, Ptr[uint8](addr(iv)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: CBC decryption failed\n"))
        return
    print_block(Ptr[uint8]("Decrypted"), Ptr[uint8](addr(decrypted)), 32)
    if (compare_buffers(Ptr[uint8](addr(plaintext)), Ptr[uint8](addr(decrypted)), 32) != 0):
        print_str(Ptr[uint8]("✓ CBC mode test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ CBC mode test FAILED\n"))

def main() -> int32:
    print_str(Ptr[uint8]("BrainhairOS AES Encryption Test\n"))
    print_str(Ptr[uint8]("================================\n"))
    result: int32 = aes_initialize()
    if (result != 0):
        print_str(Ptr[uint8]("Error: Failed to initialize AES\n"))
        return 1
    hw_support: int32 = aes_has_hardware_support()
    if (hw_support != 0):
        print_str(Ptr[uint8]("Hardware AES-NI support: AVAILABLE\n"))
    else:
        print_str(Ptr[uint8]("Hardware AES-NI support: NOT AVAILABLE (using software)\n"))
    test_aes_128()
    test_aes_256()
    test_cbc_mode()
    print_str(Ptr[uint8]("\n================================\n"))
    print_str(Ptr[uint8]("All tests completed!\n"))
    return 0