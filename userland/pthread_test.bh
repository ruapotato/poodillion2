# pthread_test.bh - Test program for pthread implementation
# Tests thread creation, joining, detaching, and synchronization

from lib.syscalls import *
from lib.pthread import *

# ============================================================================
# Test 1: Basic thread creation and join
# ============================================================================

def simple_worker(arg: int32) -> int32:
  print(cast[*uint8]("  [Thread "))
  print_int(pthread_self())
  print(cast[*uint8]("] Hello from simple worker thread! arg="))
  print_int(arg)
  newline()

  # Do some work
  i: int32 = 0
  while i < 3:
    print(cast[*uint8]("  [Thread "))
    print_int(pthread_self())
    print(cast[*uint8]("] Working... "))
    print_int(i)
    newline()
    thread_yield()
    i = i + 1

  print(cast[*uint8]("  [Thread "))
  print_int(pthread_self())
  print(cast[*uint8]("] Worker done, returning "))
  print_int(arg * 2)
  newline()

  return arg * 2

def test_basic_thread_join():
  print(cast[*uint8]("\n=== Test 1: Basic Thread Creation and Join ===\n"))

  thread: pthread_t = 0
  result: int32 = 0

  print(cast[*uint8]("[Main] Creating thread...\n"))
  if pthread_create(addr(thread), cast[*pthread_attr_t](0),
                   cast[int32](addr(simple_worker)), 42) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread\n"))
    return

  print(cast[*uint8]("[Main] Thread created with TID="))
  print_int(thread)
  newline()

  print(cast[*uint8]("[Main] Waiting for thread to finish...\n"))
  if pthread_join(thread, addr(result)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread\n"))
    return

  print(cast[*uint8]("[Main] Thread joined successfully!\n"))
  print(cast[*uint8]("[Main] Thread returned: "))
  print_int(result)
  newline()

# ============================================================================
# Test 2: Multiple threads
# ============================================================================

def multi_worker(arg: int32) -> int32:
  my_id: int32 = pthread_self()

  print(cast[*uint8]("  [Thread "))
  print_int(my_id)
  print(cast[*uint8]("] Started with arg="))
  print_int(arg)
  newline()

  # Do some iterations
  i: int32 = 0
  while i < 2:
    print(cast[*uint8]("  [Thread "))
    print_int(my_id)
    print(cast[*uint8]("] Iteration "))
    print_int(i)
    newline()
    thread_yield()
    i = i + 1

  print(cast[*uint8]("  [Thread "))
  print_int(my_id)
  print(cast[*uint8]("] Exiting\n"))

  return arg + 100

def test_multiple_threads():
  print(cast[*uint8]("\n=== Test 2: Multiple Threads ===\n"))

  thread1: pthread_t = 0
  thread2: pthread_t = 0
  thread3: pthread_t = 0
  result1: int32 = 0
  result2: int32 = 0
  result3: int32 = 0

  print(cast[*uint8]("[Main] Creating 3 threads...\n"))

  if pthread_create(addr(thread1), cast[*pthread_attr_t](0),
                   cast[int32](addr(multi_worker)), 1) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread 1\n"))
    return

  if pthread_create(addr(thread2), cast[*pthread_attr_t](0),
                   cast[int32](addr(multi_worker)), 2) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread 2\n"))
    return

  if pthread_create(addr(thread3), cast[*pthread_attr_t](0),
                   cast[int32](addr(multi_worker)), 3) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread 3\n"))
    return

  print(cast[*uint8]("[Main] All threads created. TIDs: "))
  print_int(thread1)
  print(cast[*uint8](", "))
  print_int(thread2)
  print(cast[*uint8](", "))
  print_int(thread3)
  newline()

  # Join all threads
  print(cast[*uint8]("[Main] Joining threads...\n"))

  if pthread_join(thread1, addr(result1)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread 1\n"))
  if pthread_join(thread2, addr(result2)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread 2\n"))
  if pthread_join(thread3, addr(result3)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread 3\n"))

  print(cast[*uint8]("[Main] All threads joined!\n"))
  print(cast[*uint8]("[Main] Results: "))
  print_int(result1)
  print(cast[*uint8](", "))
  print_int(result2)
  print(cast[*uint8](", "))
  print_int(result3)
  newline()

# ============================================================================
# Test 3: Detached threads
# ============================================================================

def detached_worker(arg: int32) -> int32:
  print(cast[*uint8]("  [Detached Thread "))
  print_int(pthread_self())
  print(cast[*uint8]("] Running and will auto-cleanup...\n"))

  i: int32 = 0
  while i < 2:
    thread_yield()
    i = i + 1

  print(cast[*uint8]("  [Detached Thread "))
  print_int(pthread_self())
  print(cast[*uint8]("] Exiting (no join needed)\n"))

  return 0

def test_detached_thread():
  print(cast[*uint8]("\n=== Test 3: Detached Thread ===\n"))

  attr: pthread_attr_t
  thread: pthread_t = 0

  # Initialize attributes
  _ = pthread_attr_init(addr(attr))

  # Set to detached
  _ = pthread_attr_setdetachstate(addr(attr), PTHREAD_CREATE_DETACHED)

  print(cast[*uint8]("[Main] Creating detached thread...\n"))
  if pthread_create(addr(thread), addr(attr),
                   cast[int32](addr(detached_worker)), 99) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create detached thread\n"))
    return

  print(cast[*uint8]("[Main] Detached thread created with TID="))
  print_int(thread)
  newline()
  print(cast[*uint8]("[Main] Not joining (detached threads clean up automatically)\n"))

  # Give detached thread time to run
  i: int32 = 0
  while i < 5:
    thread_yield()
    i = i + 1

  _ = pthread_attr_destroy(addr(attr))

# ============================================================================
# Test 4: pthread_self and pthread_equal
# ============================================================================

def identity_worker(arg: int32) -> int32:
  my_tid: pthread_t = pthread_self()

  print(cast[*uint8]("  [Thread] My TID from pthread_self: "))
  print_int(my_tid)
  newline()

  # Test pthread_equal with ourselves
  if pthread_equal(my_tid, my_tid) != 0:
    print(cast[*uint8]("  [Thread] pthread_equal(self, self) = TRUE (correct)\n"))
  else:
    print(cast[*uint8]("  [Thread] ERROR: pthread_equal(self, self) = FALSE\n"))

  return my_tid

def test_thread_identity():
  print(cast[*uint8]("\n=== Test 4: Thread Identity (pthread_self, pthread_equal) ===\n"))

  main_tid: pthread_t = pthread_self()
  print(cast[*uint8]("[Main] My TID: "))
  print_int(main_tid)
  newline()

  thread: pthread_t = 0
  result: int32 = 0

  if pthread_create(addr(thread), cast[*pthread_attr_t](0),
                   cast[int32](addr(identity_worker)), 0) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread\n"))
    return

  if pthread_join(thread, addr(result)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread\n"))
    return

  print(cast[*uint8]("[Main] Thread reported TID: "))
  print_int(result)
  newline()

  if pthread_equal(thread, result) != 0:
    print(cast[*uint8]("[Main] pthread_equal(created_tid, returned_tid) = TRUE (correct)\n"))
  else:
    print(cast[*uint8]("[Main] ERROR: Thread TIDs don't match!\n"))

  if pthread_equal(main_tid, thread) == 0:
    print(cast[*uint8]("[Main] pthread_equal(main, thread) = FALSE (correct)\n"))
  else:
    print(cast[*uint8]("[Main] ERROR: Main and thread TIDs are equal!\n"))

# ============================================================================
# Test 5: Thread with null return value pointer
# ============================================================================

def no_return_worker(arg: int32) -> int32:
  print(cast[*uint8]("  [Thread "))
  print_int(pthread_self())
  print(cast[*uint8]("] This thread's return value will be ignored\n"))
  return 12345

def test_join_no_return():
  print(cast[*uint8]("\n=== Test 5: Join without return value ===\n"))

  thread: pthread_t = 0

  if pthread_create(addr(thread), cast[*pthread_attr_t](0),
                   cast[int32](addr(no_return_worker)), 0) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread\n"))
    return

  print(cast[*uint8]("[Main] Joining thread without capturing return value...\n"))
  if pthread_join(thread, cast[*int32](0)) != 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread\n"))
    return

  print(cast[*uint8]("[Main] Successfully joined (return value ignored)\n"))

# ============================================================================
# Main test runner
# ============================================================================

def main():
  print(cast[*uint8]("\n"))
  print(cast[*uint8]("================================================\n"))
  print(cast[*uint8]("  BrainhairOS pthread Implementation Test\n"))
  print(cast[*uint8]("  1:1 Threading Model (User-Kernel Threads)\n"))
  print(cast[*uint8]("================================================\n"))

  # Run all tests
  test_basic_thread_join()
  test_multiple_threads()
  test_detached_thread()
  test_thread_identity()
  test_join_no_return()

  print(cast[*uint8]("\n"))
  print(cast[*uint8]("================================================\n"))
  print(cast[*uint8]("  All pthread tests completed!\n"))
  print(cast[*uint8]("================================================\n"))
  print(cast[*uint8]("\n"))

  exit(0)
