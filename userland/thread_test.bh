# thread_test.bh - Test kernel threading support
# Tests basic thread creation, execution, and yielding

from lib.syscalls import *

# Thread system calls (custom for BrainhairOS)
const SYS_thread_create: int32 = 200
const SYS_thread_exit: int32 = 201
const SYS_thread_yield: int32 = 202
const SYS_get_thread_id: int32 = 203
const SYS_is_thread: int32 = 204

# Thread function wrappers
def thread_create(entry: int32, stack_ptr: int32) -> int32:
  return syscall2(SYS_thread_create, entry, stack_ptr)

def thread_exit(code: int32):
  syscall1(SYS_thread_exit, code)

def thread_yield():
  syscall1(SYS_thread_yield, 0)

def get_thread_id() -> int32:
  return syscall1(SYS_get_thread_id, 0)

def is_thread() -> int32:
  return syscall1(SYS_is_thread, 0)

# Simple print function
def print_msg(msg: *uint8):
  len: int32 = 0
  while msg[len] != cast[uint8](0):
    len = len + 1
  write(STDOUT, msg, len)

def print_int(num: int32):
  if num == 0:
    write(STDOUT, "0", 1)
    return

  buf: array[12, uint8]
  i: int32 = 0
  n: int32 = num

  if n < 0:
    write(STDOUT, "-", 1)
    n = 0 - n

  while n > 0:
    digit: int32 = n - (n / 10) * 10
    buf[i] = cast[uint8](48 + digit)
    n = n / 10
    i = i + 1

  while i > 0:
    i = i - 1
    write(STDOUT, addr(buf[i]), 1)

# Counter shared between threads (no locking for this simple test)
shared_counter: int32 = 0

# Thread 1 function
def thread1_func():
  tid: int32 = get_thread_id()
  pid: int32 = getpid()

  print_msg("[Thread 1] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  i: int32 = 0
  while i < 5:
    print_msg("[Thread 1] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 1
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 1] Exiting\n")
  thread_exit(0)

# Thread 2 function
def thread2_func():
  tid: int32 = get_thread_id()
  pid: int32 = getpid()

  print_msg("[Thread 2] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  i: int32 = 0
  while i < 5:
    print_msg("[Thread 2] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 10
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 2] Exiting\n")
  thread_exit(0)

# Thread 3 function
def thread3_func():
  tid: int32 = get_thread_id()
  pid: int32 = getpid()

  print_msg("[Thread 3] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  i: int32 = 0
  while i < 5:
    print_msg("[Thread 3] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 100
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 3] Exiting\n")
  thread_exit(0)

# Main program
def main() -> int32:
  print_msg("===== BrainhairOS Kernel Threading Test =====\n")
  print_msg("Main process starting...\n")

  main_pid: int32 = getpid()
  main_tid: int32 = get_thread_id()
  is_thr: int32 = is_thread()

  print_msg("Main PID: ")
  print_int(main_pid)
  print_msg(", TID: ")
  print_int(main_tid)
  print_msg(", is_thread: ")
  print_int(is_thr)
  print_msg("\n\n")

  # Create threads
  print_msg("Creating thread 1...\n")
  t1: int32 = thread_create(cast[int32](addr(thread1_func)), 0)
  if t1 < 0:
    print_msg("ERROR: Failed to create thread 1\n")
    return 1
  print_msg("Thread 1 created with PID: ")
  print_int(t1)
  print_msg("\n")

  print_msg("Creating thread 2...\n")
  t2: int32 = thread_create(cast[int32](addr(thread2_func)), 0)
  if t2 < 0:
    print_msg("ERROR: Failed to create thread 2\n")
    return 1
  print_msg("Thread 2 created with PID: ")
  print_int(t2)
  print_msg("\n")

  print_msg("Creating thread 3...\n")
  t3: int32 = thread_create(cast[int32](addr(thread3_func)), 0)
  if t3 < 0:
    print_msg("ERROR: Failed to create thread 3\n")
    return 1
  print_msg("Thread 3 created with PID: ")
  print_int(t3)
  print_msg("\n\n")

  # Main thread does some work too
  i: int32 = 0
  while i < 10:
    print_msg("[Main] Iteration ")
    print_int(i)
    print_msg(", yielding to other threads...\n")
    thread_yield()
    i = i + 1

  # Give threads time to finish
  print_msg("\n[Main] Waiting for threads to complete...\n")
  j: int32 = 0
  while j < 20:
    thread_yield()
    j = j + 1

  print_msg("\n===== Thread Test Complete =====\n")
  print_msg("Final shared_counter value: ")
  print_int(shared_counter)
  print_msg("\n")
  print_msg("Expected: ~1500 (5*1 + 5*10 + 5*100 per thread = 555 per thread)\n")

  return 0

main()
