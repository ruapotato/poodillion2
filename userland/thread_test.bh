# thread_test.bh - Test kernel threading support
# Tests basic thread creation, execution, and yielding

import "lib/syscalls"

# Thread system calls (custom for BrainhairOS)
const SYS_thread_create: int32 = 200
const SYS_thread_exit: int32 = 201
const SYS_thread_yield: int32 = 202
const SYS_get_thread_id: int32 = 203
const SYS_is_thread: int32 = 204

# Thread function wrappers
proc thread_create(entry: int32, stack_ptr: int32): int32 =
  return syscall2(SYS_thread_create, entry, stack_ptr)

proc thread_exit(code: int32) =
  discard syscall1(SYS_thread_exit, code)

proc thread_yield() =
  discard syscall1(SYS_thread_yield, 0)

proc get_thread_id(): int32 =
  return syscall1(SYS_get_thread_id, 0)

proc is_thread(): int32 =
  return syscall1(SYS_is_thread, 0)

# Simple print function
proc print_msg(msg: ptr uint8) =
  var len: int32 = 0
  while msg[len] != cast[uint8](0):
    len = len + 1
  discard write(STDOUT, msg, len)

proc print_int(num: int32) =
  if num == 0:
    discard write(STDOUT, "0", 1)
    return

  var buf: array[12, uint8]
  var i: int32 = 0
  var n: int32 = num

  if n < 0:
    discard write(STDOUT, "-", 1)
    n = 0 - n

  while n > 0:
    var digit: int32 = n - (n / 10) * 10
    buf[i] = cast[uint8](48 + digit)
    n = n / 10
    i = i + 1

  while i > 0:
    i = i - 1
    discard write(STDOUT, addr(buf[i]), 1)

# Counter shared between threads (no locking for this simple test)
var shared_counter: int32 = 0

# Thread 1 function
proc thread1_func() =
  var tid: int32 = get_thread_id()
  var pid: int32 = getpid()

  print_msg("[Thread 1] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  var i: int32 = 0
  while i < 5:
    print_msg("[Thread 1] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 1
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 1] Exiting\n")
  thread_exit(0)

# Thread 2 function
proc thread2_func() =
  var tid: int32 = get_thread_id()
  var pid: int32 = getpid()

  print_msg("[Thread 2] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  var i: int32 = 0
  while i < 5:
    print_msg("[Thread 2] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 10
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 2] Exiting\n")
  thread_exit(0)

# Thread 3 function
proc thread3_func() =
  var tid: int32 = get_thread_id()
  var pid: int32 = getpid()

  print_msg("[Thread 3] Started - PID: ")
  print_int(pid)
  print_msg(", TID: ")
  print_int(tid)
  print_msg("\n")

  # Do some work
  var i: int32 = 0
  while i < 5:
    print_msg("[Thread 3] Iteration ")
    print_int(i)
    print_msg(", counter = ")
    shared_counter = shared_counter + 100
    print_int(shared_counter)
    print_msg("\n")

    # Yield to other threads
    thread_yield()
    i = i + 1

  print_msg("[Thread 3] Exiting\n")
  thread_exit(0)

# Main program
proc main(): int32 =
  print_msg("===== BrainhairOS Kernel Threading Test =====\n")
  print_msg("Main process starting...\n")

  var main_pid: int32 = getpid()
  var main_tid: int32 = get_thread_id()
  var is_thr: int32 = is_thread()

  print_msg("Main PID: ")
  print_int(main_pid)
  print_msg(", TID: ")
  print_int(main_tid)
  print_msg(", is_thread: ")
  print_int(is_thr)
  print_msg("\n\n")

  # Create threads
  print_msg("Creating thread 1...\n")
  var t1: int32 = thread_create(cast[int32](addr(thread1_func)), 0)
  if t1 < 0:
    print_msg("ERROR: Failed to create thread 1\n")
    return 1
  print_msg("Thread 1 created with PID: ")
  print_int(t1)
  print_msg("\n")

  print_msg("Creating thread 2...\n")
  var t2: int32 = thread_create(cast[int32](addr(thread2_func)), 0)
  if t2 < 0:
    print_msg("ERROR: Failed to create thread 2\n")
    return 1
  print_msg("Thread 2 created with PID: ")
  print_int(t2)
  print_msg("\n")

  print_msg("Creating thread 3...\n")
  var t3: int32 = thread_create(cast[int32](addr(thread3_func)), 0)
  if t3 < 0:
    print_msg("ERROR: Failed to create thread 3\n")
    return 1
  print_msg("Thread 3 created with PID: ")
  print_int(t3)
  print_msg("\n\n")

  # Main thread does some work too
  var i: int32 = 0
  while i < 10:
    print_msg("[Main] Iteration ")
    print_int(i)
    print_msg(", yielding to other threads...\n")
    thread_yield()
    i = i + 1

  # Give threads time to finish
  print_msg("\n[Main] Waiting for threads to complete...\n")
  var j: int32 = 0
  while j < 20:
    thread_yield()
    j = j + 1

  print_msg("\n===== Thread Test Complete =====\n")
  print_msg("Final shared_counter value: ")
  print_int(shared_counter)
  print_msg("\n")
  print_msg("Expected: ~1500 (5*1 + 5*10 + 5*100 per thread = 555 per thread)\n")

  return 0

main()
