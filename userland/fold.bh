# fold - wrap lines to specified width
# Usage: fold [-w WIDTH] [FILE]
# Default width: 80 characters
# Part of BrainhairOS text utilities

from lib.syscalls import *

extern def get_argc() -> int32
extern def get_argv(index: int32) -> *uint8

def print_err(msg: *uint8):
    len: int32 = strlen(msg)
    _ = syscall3(SYS_write, STDERR, cast[int32](msg), len)

def parse_int(s: *uint8) -> int32:
    result: int32 = 0
    i: int32 = 0
    while s[i] >= cast[uint8](48):
        if s[i] > cast[uint8](57):
            break
        result = result * 10 + cast[int32](s[i]) - 48
        i = i + 1
    return result

def main():
    argc: int32 = get_argc()

    # Allocate buffer
    old_brk: int32 = syscall1(SYS_brk, 0)
    new_brk: int32 = old_brk + 4096
    _ = syscall1(SYS_brk, new_brk)
    buffer: *uint8 = cast[*uint8](old_brk)

    # Parse arguments
    width: int32 = 80
    input_fd: int32 = STDIN
    i: int32 = 1

    while i < argc:
        arg: *uint8 = get_argv(i)
        if strcmp(arg, cast[*uint8]("-w")) == 0:
            i = i + 1
            if i >= argc:
                print_err(cast[*uint8]("fold: -w requires width\n"))
                _ = syscall1(SYS_exit, 1)
            width_arg: *uint8 = get_argv(i)
            width = parse_int(width_arg)
            if width <= 0:
                width = 80
        else:
            if arg[0] != cast[uint8](45):  # not a flag
                input_fd = syscall2(SYS_open, cast[int32](arg), O_RDONLY)
                if input_fd < 0:
                    print_err(cast[*uint8]("fold: cannot open file\n"))
                    _ = syscall1(SYS_exit, 1)
        i = i + 1

    # Process input
    col: int32 = 0
    running: int32 = 1

    while running != 0:
        n: int32 = syscall3(SYS_read, input_fd, cast[int32](buffer), 4096)
        if n <= 0:
            running = 0
            break

        j: int32 = 0
        while j < n:
            ch: uint8 = buffer[j]

            if ch == cast[uint8](10):  # newline
                _ = syscall3(SYS_write, STDOUT, cast[int32](addr(ch)), 1)
                col = 0
            else:
                if col >= width:
                    _ = syscall3(SYS_write, STDOUT, cast[int32]("\n"), 1)
                    col = 0
                _ = syscall3(SYS_write, STDOUT, cast[int32](addr(ch)), 1)
                col = col + 1

            j = j + 1

    if input_fd != STDIN:
        _ = syscall1(SYS_close, input_fd)

    _ = syscall1(SYS_exit, 0)
