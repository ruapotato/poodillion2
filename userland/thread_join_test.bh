# thread_join_test.bh - Simple test for thread_join functionality
# Tests basic thread joining using low-level syscall API

from lib.syscalls import *

# Simple worker thread that returns doubled argument
def worker_thread(arg: int32) -> int32:
  my_tid: int32 = thread_self()

  print(cast[*uint8]("  [Thread "))
  print_int(my_tid)
  print(cast[*uint8]("] Started with arg="))
  print_int(arg)
  newline()

  # Do some work
  i: int32 = 0
  while i < 3:
    print(cast[*uint8]("  [Thread "))
    print_int(my_tid)
    print(cast[*uint8]("] Working iteration "))
    print_int(i)
    newline()
    thread_yield()
    i = i + 1

  result: int32 = arg * 2
  print(cast[*uint8]("  [Thread "))
  print_int(my_tid)
  print(cast[*uint8]("] Exiting with result="))
  print_int(result)
  newline()

  return result

def main():
  print(cast[*uint8]("\n=== BrainhairOS Thread Join Test ===\n\n"))

  # Test 1: Basic thread join
  print(cast[*uint8]("[Main] Creating thread...\n"))
  tid: int32 = thread_create(cast[int32](addr(worker_thread)), 42)

  if tid < 0:
    print(cast[*uint8]("[Main] ERROR: Failed to create thread\n"))
    exit(1)

  print(cast[*uint8]("[Main] Thread created with TID="))
  print_int(tid)
  newline()

  # Give thread some time to run
  i: int32 = 0
  while i < 2:
    print(cast[*uint8]("[Main] Main thread iteration "))
    print_int(i)
    newline()
    thread_yield()
    i = i + 1

  # Join the thread
  print(cast[*uint8]("[Main] Waiting for thread to finish...\n"))
  status: int32 = 0
  join_result: int32 = thread_join(tid, addr(status))

  if join_result < 0:
    print(cast[*uint8]("[Main] ERROR: Failed to join thread\n"))
    exit(1)

  print(cast[*uint8]("[Main] Thread joined successfully!\n"))
  print(cast[*uint8]("[Main] Thread exit status: "))
  print_int(status)
  newline()

  # Test 2: Multiple threads
  print(cast[*uint8]("\n[Main] Creating 3 threads...\n"))
  tid1: int32 = thread_create(cast[int32](addr(worker_thread)), 10)
  tid2: int32 = thread_create(cast[int32](addr(worker_thread)), 20)
  tid3: int32 = thread_create(cast[int32](addr(worker_thread)), 30)

  print(cast[*uint8]("[Main] Created threads: "))
  print_int(tid1)
  print(cast[*uint8](", "))
  print_int(tid2)
  print(cast[*uint8](", "))
  print_int(tid3)
  newline()

  # Join all threads
  status1: int32 = 0
  status2: int32 = 0
  status3: int32 = 0

  print(cast[*uint8]("[Main] Joining threads...\n"))
  _ = thread_join(tid1, addr(status1))
  _ = thread_join(tid2, addr(status2))
  _ = thread_join(tid3, addr(status3))

  print(cast[*uint8]("[Main] All threads joined!\n"))
  print(cast[*uint8]("[Main] Results: "))
  print_int(status1)
  print(cast[*uint8](", "))
  print_int(status2)
  print(cast[*uint8](", "))
  print_int(status3)
  newline()

  # Test 3: Detached thread
  print(cast[*uint8]("\n[Main] Creating detached thread...\n"))
  detached_tid: int32 = thread_create(cast[int32](addr(worker_thread)), 99)
  _ = thread_detach(detached_tid)
  print(cast[*uint8]("[Main] Thread "))
  print_int(detached_tid)
  print(cast[*uint8](" detached (will auto-cleanup)\n"))

  # Give detached thread time to run
  i = 0
  while i < 5:
    thread_yield()
    i = i + 1

  print(cast[*uint8]("\n=== All tests completed successfully! ===\n\n"))
  exit(0)
