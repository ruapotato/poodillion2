from lib.syscalls import write, exit, STDOUT
from lib.chacha20 import chacha20_encrypt, CHACHA20_KEY_SIZE, CHACHA20_NONCE_SIZE
from lib.poly1305 import poly1305_auth, poly1305_init, poly1305_update, poly1305_final, POLY1305_KEY_SIZE, POLY1305_TAG_SIZE

def print_str(msg: Ptr[uint8]):
    len: int32 = 0
    p: Ptr[uint8] = msg
    while (p[len] != cast[uint8](0)):
        len = (len + 1)
    write(STDOUT, msg, len)

def print_hex_byte(b: uint8):
    hex: Array[3, uint8]
    nibble_high: int32 = (cast[int32](b) >> 4)
    nibble_low: int32 = (cast[int32](b) & 15)
    if (nibble_high < 10):
        hex[0] = cast[uint8]((48 + nibble_high))
    else:
        hex[0] = cast[uint8](((97 + nibble_high) - 10))
    if (nibble_low < 10):
        hex[1] = cast[uint8]((48 + nibble_low))
    else:
        hex[1] = cast[uint8](((97 + nibble_low) - 10))
    hex[2] = cast[uint8](0)
    print_str(Ptr[uint8](addr(hex)))

def print_hex_buffer(buf: Ptr[uint8], len: int32):
    i: int32 = 0
    while (i < len):
        print_hex_byte(buf[i])
        if (i < (len - 1)):
            print_str(Ptr[uint8](" "))
        i = (i + 1)

def print_block(label: Ptr[uint8], buf: Ptr[uint8], len: int32):
    print_str(label)
    print_str(Ptr[uint8](": "))
    print_hex_buffer(buf, len)
    print_str(Ptr[uint8]("\n"))

def compare_buffers(buf1: Ptr[uint8], buf2: Ptr[uint8], len: int32) -> int32:
    i: int32 = 0
    while (i < len):
        if (buf1[i] != buf2[i]):
            return 0
        i = (i + 1)
    return 1

def test_poly1305_rfc8439():
    print_str(Ptr[uint8]("\n=== Poly1305 MAC Test (RFC 8439 Section 2.5.2) ===\n"))
    key: Array[32, uint8]
    key[0] = cast[uint8](133)
    key[1] = cast[uint8](214)
    key[2] = cast[uint8](190)
    key[3] = cast[uint8](120)
    key[4] = cast[uint8](87)
    key[5] = cast[uint8](85)
    key[6] = cast[uint8](109)
    key[7] = cast[uint8](51)
    key[8] = cast[uint8](127)
    key[9] = cast[uint8](68)
    key[10] = cast[uint8](82)
    key[11] = cast[uint8](254)
    key[12] = cast[uint8](66)
    key[13] = cast[uint8](213)
    key[14] = cast[uint8](6)
    key[15] = cast[uint8](168)
    key[16] = cast[uint8](1)
    key[17] = cast[uint8](3)
    key[18] = cast[uint8](128)
    key[19] = cast[uint8](138)
    key[20] = cast[uint8](251)
    key[21] = cast[uint8](13)
    key[22] = cast[uint8](178)
    key[23] = cast[uint8](253)
    key[24] = cast[uint8](74)
    key[25] = cast[uint8](191)
    key[26] = cast[uint8](246)
    key[27] = cast[uint8](175)
    key[28] = cast[uint8](65)
    key[29] = cast[uint8](73)
    key[30] = cast[uint8](245)
    key[31] = cast[uint8](27)
    msg: Ptr[uint8] = Ptr[uint8]("Cryptographic Forum Research Group")
    msg_len: int32 = 34
    expected_tag: Array[16, uint8]
    expected_tag[0] = cast[uint8](168)
    expected_tag[1] = cast[uint8](6)
    expected_tag[2] = cast[uint8](29)
    expected_tag[3] = cast[uint8](193)
    expected_tag[4] = cast[uint8](48)
    expected_tag[5] = cast[uint8](81)
    expected_tag[6] = cast[uint8](54)
    expected_tag[7] = cast[uint8](198)
    expected_tag[8] = cast[uint8](194)
    expected_tag[9] = cast[uint8](43)
    expected_tag[10] = cast[uint8](139)
    expected_tag[11] = cast[uint8](175)
    expected_tag[12] = cast[uint8](12)
    expected_tag[13] = cast[uint8](1)
    expected_tag[14] = cast[uint8](39)
    expected_tag[15] = cast[uint8](169)
    computed_tag: Array[16, uint8]
    print_str(Ptr[uint8]("Message: \"Cryptographic Forum Research Group\"\n"))
    print_block(Ptr[uint8]("Key"), Ptr[uint8](addr(key)), 32)
    result: int32 = poly1305_auth(Ptr[uint8](addr(computed_tag)), msg, msg_len, Ptr[uint8](addr(key)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Poly1305 computation failed\n"))
        return
    print_block(Ptr[uint8]("Computed Tag"), Ptr[uint8](addr(computed_tag)), 16)
    print_block(Ptr[uint8]("Expected Tag"), Ptr[uint8](addr(expected_tag)), 16)
    if (compare_buffers(Ptr[uint8](addr(computed_tag)), Ptr[uint8](addr(expected_tag)), 16) != 0):
        print_str(Ptr[uint8]("✓ Poly1305 RFC 8439 test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ Poly1305 RFC 8439 test FAILED\n"))

def test_poly1305_incremental():
    print_str(Ptr[uint8]("\n=== Poly1305 Incremental Update Test ===\n"))
    key: Array[32, uint8]
    i: int32 = 0
    while (i < 32):
        key[i] = cast[uint8]((i + 1))
        i = (i + 1)
    part1: Ptr[uint8] = Ptr[uint8]("Hello, ")
    part2: Ptr[uint8] = Ptr[uint8]("World!")
    tag_incremental: Array[16, uint8]
    result: int32 = poly1305_init(Ptr[uint8](addr(key)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Poly1305 init failed\n"))
        return
    poly1305_update(part1, 7)
    poly1305_update(part2, 6)
    result = poly1305_final(Ptr[uint8](addr(tag_incremental)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Poly1305 final failed\n"))
        return
    full_msg: Ptr[uint8] = Ptr[uint8]("Hello, World!")
    tag_oneshot: Array[16, uint8]
    result = poly1305_auth(Ptr[uint8](addr(tag_oneshot)), full_msg, 13, Ptr[uint8](addr(key)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: Poly1305 one-shot failed\n"))
        return
    print_block(Ptr[uint8]("Incremental Tag"), Ptr[uint8](addr(tag_incremental)), 16)
    print_block(Ptr[uint8]("One-shot Tag"), Ptr[uint8](addr(tag_oneshot)), 16)
    if (compare_buffers(Ptr[uint8](addr(tag_incremental)), Ptr[uint8](addr(tag_oneshot)), 16) != 0):
        print_str(Ptr[uint8]("✓ Incremental update test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ Incremental update test FAILED\n"))

def test_chacha20_encryption():
    print_str(Ptr[uint8]("\n=== ChaCha20 Encryption Test ===\n"))
    key: Array[32, uint8]
    i: int32 = 0
    while (i < 32):
        key[i] = cast[uint8](((i * 7) + 13))
        i = (i + 1)
    nonce: Array[12, uint8]
    i = 0
    while (i < 12):
        nonce[i] = cast[uint8]((i + 1))
        i = (i + 1)
    plaintext: Ptr[uint8] = Ptr[uint8]("Attack at dawn!")
    plaintext_len: int32 = 15
    ciphertext: Array[32, uint8]
    decrypted: Array[32, uint8]
    print_str(Ptr[uint8]("Plaintext: \"Attack at dawn!\"\n"))
    print_block(Ptr[uint8]("Key"), Ptr[uint8](addr(key)), 32)
    print_block(Ptr[uint8]("Nonce"), Ptr[uint8](addr(nonce)), 12)
    chacha20_encrypt(plaintext, Ptr[uint8](addr(ciphertext)), plaintext_len, Ptr[uint8](addr(key)), Ptr[uint8](addr(nonce)), 1)
    print_block(Ptr[uint8]("Ciphertext"), Ptr[uint8](addr(ciphertext)), plaintext_len)
    chacha20_encrypt(Ptr[uint8](addr(ciphertext)), Ptr[uint8](addr(decrypted)), plaintext_len, Ptr[uint8](addr(key)), Ptr[uint8](addr(nonce)), 1)
    print_str(Ptr[uint8]("Decrypted: \""))
    write(STDOUT, Ptr[uint8](addr(decrypted)), plaintext_len)
    print_str(Ptr[uint8]("\"\n"))
    if (compare_buffers(plaintext, Ptr[uint8](addr(decrypted)), plaintext_len) != 0):
        print_str(Ptr[uint8]("✓ ChaCha20 encryption test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ ChaCha20 encryption test FAILED\n"))

def test_simple_aead():
    print_str(Ptr[uint8]("\n=== Simple AEAD Test ===\n"))
    print_str(Ptr[uint8]("(Manual construction without full AEAD library)\n"))
    key: Array[32, uint8]
    i: int32 = 0
    while (i < 32):
        key[i] = cast[uint8]((i + 42))
        i = (i + 1)
    nonce: Array[12, uint8]
    i = 0
    while (i < 12):
        nonce[i] = cast[uint8](((i * 2) + 7))
        i = (i + 1)
    poly_key_buf: Array[64, uint8]
    chacha20_encrypt(Ptr[uint8](addr(poly_key_buf)), Ptr[uint8](addr(poly_key_buf)), 64, Ptr[uint8](addr(key)), Ptr[uint8](addr(nonce)), 0)
    poly_key: Array[32, uint8]
    i = 0
    while (i < 32):
        poly_key[i] = poly_key_buf[i]
        i = (i + 1)
    plaintext: Ptr[uint8] = Ptr[uint8]("Secret message")
    plaintext_len: int32 = 14
    ciphertext: Array[32, uint8]
    chacha20_encrypt(plaintext, Ptr[uint8](addr(ciphertext)), plaintext_len, Ptr[uint8](addr(key)), Ptr[uint8](addr(nonce)), 1)
    tag: Array[16, uint8]
    result: int32 = poly1305_auth(Ptr[uint8](addr(tag)), Ptr[uint8](addr(ciphertext)), plaintext_len, Ptr[uint8](addr(poly_key)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: MAC computation failed\n"))
        return
    print_str(Ptr[uint8]("Plaintext: \"Secret message\"\n"))
    print_block(Ptr[uint8]("Ciphertext"), Ptr[uint8](addr(ciphertext)), plaintext_len)
    print_block(Ptr[uint8]("Auth Tag"), Ptr[uint8](addr(tag)), 16)
    computed_tag: Array[16, uint8]
    result = poly1305_auth(Ptr[uint8](addr(computed_tag)), Ptr[uint8](addr(ciphertext)), plaintext_len, Ptr[uint8](addr(poly_key)))
    if (result != 0):
        print_str(Ptr[uint8]("Error: MAC verification failed\n"))
        return
    if (compare_buffers(Ptr[uint8](addr(tag)), Ptr[uint8](addr(computed_tag)), 16) == 0):
        print_str(Ptr[uint8]("✗ Authentication FAILED - message tampered!\n"))
        return
    print_str(Ptr[uint8]("✓ Authentication PASSED\n"))
    decrypted: Array[32, uint8]
    chacha20_encrypt(Ptr[uint8](addr(ciphertext)), Ptr[uint8](addr(decrypted)), plaintext_len, Ptr[uint8](addr(key)), Ptr[uint8](addr(nonce)), 1)
    print_str(Ptr[uint8]("Decrypted: \""))
    write(STDOUT, Ptr[uint8](addr(decrypted)), plaintext_len)
    print_str(Ptr[uint8]("\"\n"))
    if (compare_buffers(plaintext, Ptr[uint8](addr(decrypted)), plaintext_len) != 0):
        print_str(Ptr[uint8]("✓ Simple AEAD test PASSED\n"))
    else:
        print_str(Ptr[uint8]("✗ Simple AEAD test FAILED\n"))

def main() -> int32:
    print_str(Ptr[uint8]("BrainhairOS ChaCha20-Poly1305 AEAD Test\n"))
    print_str(Ptr[uint8]("=========================================\n"))
    print_str(Ptr[uint8]("\nThis test suite validates:\n"))
    print_str(Ptr[uint8]("  - Poly1305 MAC (RFC 8439 test vectors)\n"))
    print_str(Ptr[uint8]("  - ChaCha20 stream cipher\n"))
    print_str(Ptr[uint8]("  - Combined AEAD construction\n"))
    test_poly1305_rfc8439()
    test_poly1305_incremental()
    test_chacha20_encryption()
    test_simple_aead()
    print_str(Ptr[uint8]("\n=========================================\n"))
    print_str(Ptr[uint8]("All tests completed!\n"))
    print_str(Ptr[uint8]("\nChaCha20-Poly1305 AEAD cipher suite is ready for use.\n"))
    print_str(Ptr[uint8]("See lib/aead.bh for full AEAD API with AAD support.\n"))
    return 0