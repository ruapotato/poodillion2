# Test hard link functionality
# Creates a file, links it, verifies both files point to same inode

from lib.syscalls import *

extern def get_argc() -> int32
extern def get_argv(i: int32) -> *uint8

def main() -> int32:
  print("=== Hard Link Test ===")
  newline()

  # Create a test file
  testfile: *uint8 = cast[*uint8]("testfile.txt")
  linkname: *uint8 = cast[*uint8]("linkname.txt")
  content: *uint8 = cast[*uint8]("Hello from hard link test!\n")

  # Create file
  fd: int32 = syscall3(SYS_open, cast[int32](testfile), O_WRONLY | O_CREAT | O_TRUNC, 420)
  if fd < 0:
    perror("Failed to create test file")
    return 1

  # Write content
  len: int32 = strlen(content)
  if syscall3(SYS_write, fd, cast[int32](content), len) != len:
    perror("Failed to write to test file")
    syscall1(SYS_close, fd)
    return 1

  syscall1(SYS_close, fd)
  print("Created testfile.txt")
  newline()

  # Create hard link
  if syscall2(SYS_link, cast[int32](testfile), cast[int32](linkname)) < 0:
    perror("Failed to create hard link")
    return 1

  print("Created hard link linkname.txt -> testfile.txt")
  newline()

  # Read from original file
  fd = syscall3(SYS_open, cast[int32](testfile), O_RDONLY, 0)
  if fd < 0:
    perror("Failed to open testfile.txt")
    return 1

  buf1: array[128, uint8]
  n1: int32 = syscall3(SYS_read, fd, cast[int32](addr(buf1[0])), 128)
  syscall1(SYS_close, fd)

  print("Content from testfile.txt: ")
  if n1 > 0:
    buf1[n1] = cast[uint8](0)
    print(addr(buf1[0]))
  newline()

  # Read from linked file
  fd = syscall3(SYS_open, cast[int32](linkname), O_RDONLY, 0)
  if fd < 0:
    perror("Failed to open linkname.txt")
    return 1

  buf2: array[128, uint8]
  n2: int32 = syscall3(SYS_read, fd, cast[int32](addr(buf2[0])), 128)
  syscall1(SYS_close, fd)

  print("Content from linkname.txt: ")
  if n2 > 0:
    buf2[n2] = cast[uint8](0)
    print(addr(buf2[0]))
  newline()

  # Verify content is identical
  if n1 == n2:
    same: int32 = 1
    i: int32 = 0
    while i < n1:
      if buf1[i] != buf2[i]:
        same = 0
        i = n1
      i = i + 1
    if same == 1:
      print("SUCCESS: Both files have identical content")
      newline()
    else:
      print("ERROR: File contents differ")
      newline()
      return 1
  else:
    print("ERROR: File sizes differ")
    newline()
    return 1

  # Test unlink - delete original file
  print("Unlinking testfile.txt...")
  newline()
  if syscall1(SYS_unlink, cast[int32](testfile)) < 0:
    perror("Failed to unlink testfile.txt")
    return 1

  # Verify linked file still exists and is readable
  fd = syscall3(SYS_open, cast[int32](linkname), O_RDONLY, 0)
  if fd < 0:
    perror("ERROR: linkname.txt disappeared after unlink")
    return 1

  buf3: array[128, uint8]
  n3: int32 = syscall3(SYS_read, fd, cast[int32](addr(buf3[0])), 128)
  syscall1(SYS_close, fd)

  if n3 == n1:
    print("SUCCESS: Linked file still readable after unlinking original")
    newline()
  else:
    print("ERROR: Linked file size changed")
    newline()
    return 1

  # Cleanup - unlink the remaining file
  syscall1(SYS_unlink, cast[int32](linkname))

  print("=== All Tests Passed ===")
  newline()
  return 0
