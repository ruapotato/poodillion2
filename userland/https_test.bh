# https_test.bh - Test HTTPS connectivity
#
# Simple HTTPS client test that connects to a server and fetches a page

from lib.syscalls import *
from lib.net import *
from lib.dns import *
from lib.tls13 import *

def main() -> int32:
    print(cast[Ptr[uint8]]("HTTPS Test Client\n"))
    print(cast[Ptr[uint8]]("=================\n\n"))

    # Buffer for response
    response: Array[4096, uint8]

    # Test 1: Simple HTTPS GET
    print(cast[Ptr[uint8]]("Testing HTTPS connection...\n"))

    # Create TLS connection
    conn: TLSConnection
    tls_init(addr(conn))

    # Test with a simple host (example.com on port 443)
    host: Ptr[uint8] = cast[Ptr[uint8]]("example.com")
    port: int32 = 443
    path: Ptr[uint8] = cast[Ptr[uint8]]("/")

    print(cast[Ptr[uint8]]("Resolving host: "))
    print(host)
    print(cast[Ptr[uint8]]("\n"))

    # Resolve hostname to IP
    ip: Array[4, uint8]
    if dns_resolve(host, addr(ip[0])) < 0:
        print(cast[Ptr[uint8]]("DNS resolution failed\n"))
        return 1

    print(cast[Ptr[uint8]]("Resolved to: "))
    print_ip(addr(ip[0]))
    print(cast[Ptr[uint8]]("\n"))

    # Attempt HTTPS GET using the high-level API
    print(cast[Ptr[uint8]]("Connecting with TLS 1.3...\n"))

    result: int32 = tls_https_get(host, port, path, addr(response[0]), 4096)

    if result < 0:
        print(cast[Ptr[uint8]]("HTTPS request failed\n"))

        # Try to diagnose
        state: int32 = tls_get_state(addr(conn))
        print(cast[Ptr[uint8]]("Connection state: "))
        print_int(state)
        print(cast[Ptr[uint8]]("\n"))

        return 1

    print(cast[Ptr[uint8]]("Received "))
    print_int(result)
    print(cast[Ptr[uint8]](" bytes\n\n"))

    # Print response (first 500 chars)
    print(cast[Ptr[uint8]]("Response:\n"))
    print(cast[Ptr[uint8]]("---------\n"))

    max_print: int32 = result
    if max_print > 500:
        max_print = 500

    i: int32 = 0
    while i < max_print:
        write(STDOUT, addr(response[i]), 1)
        i = i + 1

    if result > 500:
        print(cast[Ptr[uint8]]("\n... (truncated)\n"))

    print(cast[Ptr[uint8]]("\n\nHTTPS test completed successfully!\n"))

    return 0

# Helper function to print IPv4 address
def print_ip(ip: Ptr[uint8]):
    print_int(cast[int32](ip[0]))
    print(cast[Ptr[uint8]]("."))
    print_int(cast[int32](ip[1]))
    print(cast[Ptr[uint8]]("."))
    print_int(cast[int32](ip[2]))
    print(cast[Ptr[uint8]]("."))
    print_int(cast[int32](ip[3]))
