from lib.syscalls import *
from lib.rsa import *

def main(argc: int32, argv: Ptr[Ptr[uint8]]) -> int32:
    println(Ptr[uint8]("RSA Test"))
    println(Ptr[uint8]("--------"))
    a: Array[4, int32]
    b: Array[4, int32]
    c: Array[4, int32]
    bigint_zero(addr(a[0]), 4)
    a[0] = 12345
    bigint_zero(addr(b[0]), 4)
    b[0] = 67890
    bigint_add(addr(c[0]), addr(a[0]), addr(b[0]), 4)
    print(Ptr[uint8]("12345 + 67890 = "))
    print_int(c[0])
    println(Ptr[uint8](""))
    n: Array[4, int32]
    bigint_zero(addr(n[0]), 4)
    n[0] = 100
    bigint_mod(addr(c[0]), addr(c[0]), addr(n[0]), 4)
    print(Ptr[uint8]("80235 mod 100 = "))
    print_int(c[0])
    println(Ptr[uint8](""))
    bigint_zero(addr(a[0]), 4)
    a[0] = 2
    bigint_zero(addr(n[0]), 4)
    n[0] = 1000
    bigint_powmod_small(addr(c[0]), addr(a[0]), 10, addr(n[0]), 4)
    print(Ptr[uint8]("2^10 mod 1000 = "))
    print_int(c[0])
    println(Ptr[uint8](" (expected: 24)"))
    rsa_limbs = 2
    rsa_n[0] = 3233
    rsa_n[1] = 0
    rsa_e = 17
    rsa_d[0] = 2753
    rsa_d[1] = 0
    msg: Array[8, uint8]
    encrypted: Array[8, uint8]
    decrypted: Array[8, uint8]
    msg[0] = 0
    msg[1] = 0
    msg[2] = 0
    msg[3] = 0
    msg[4] = 0
    msg[5] = 0
    msg[6] = 0
    msg[7] = 65
    println(Ptr[uint8](""))
    println(Ptr[uint8]("RSA encrypt/decrypt test:"))
    print(Ptr[uint8]("  Original: "))
    print_int(cast[int32](msg[7]))
    println(Ptr[uint8](""))
    enc_len: int32 = rsa_public(addr(encrypted[0]), addr(msg[0]), 8)
    print(Ptr[uint8]("  Encrypted: "))
    print_int(((cast[int32](encrypted[6]) * 256) + cast[int32](encrypted[7])))
    println(Ptr[uint8](""))
    dec_len: int32 = rsa_private(addr(decrypted[0]), addr(encrypted[0]), 8)
    print(Ptr[uint8]("  Decrypted: "))
    print_int(cast[int32](decrypted[7]))
    println(Ptr[uint8](""))
    println(Ptr[uint8](""))
    println(Ptr[uint8]("RSA library loaded successfully"))
    return 0