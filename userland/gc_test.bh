# gc_test - Test program for Brainhair garbage collector

from lib.syscalls import *
from lib.gc import *

# Global root for testing
global_obj: *uint8 = cast[*uint8](0)

def print_str(s: *uint8) -> int32:
    len: int32 = 0
    while s[len] != 0:
        len = len + 1
    return syscall3(SYS_write, 1, cast[int32](s), len)

def print_int(n: int32):
    old_brk: int32 = syscall1(SYS_brk, 0)
    _ = syscall1(SYS_brk, old_brk + 32)
    buf: *uint8 = cast[*uint8](old_brk)

    if n < 0:
        _ = syscall3(SYS_write, 1, cast[int32](cast[*uint8]("-")), 1)
        n = 0 - n

    i: int32 = 0
    if n == 0:
        buf[0] = 48  # '0'
        i = 1
    else:
        while n > 0:
            buf[i] = cast[uint8](48 + (n % 10))
            n = n / 10
            i = i + 1

    # Reverse
    j: int32 = 0
    while j < i / 2:
        t: uint8 = buf[j]
        buf[j] = buf[i - 1 - j]
        buf[i - 1 - j] = t
        j = j + 1

    _ = syscall3(SYS_write, 1, cast[int32](buf), i)

def print_stats():
    _ = print_str(cast[*uint8]("  Heap used: "))
    print_int(gc_get_heap_used())
    _ = print_str(cast[*uint8](" bytes\n"))

    _ = print_str(cast[*uint8]("  Objects: "))
    print_int(gc_get_object_count())
    _ = print_str(cast[*uint8]("\n"))

    _ = print_str(cast[*uint8]("  Total allocs: "))
    print_int(gc_get_total_allocations())
    _ = print_str(cast[*uint8]("\n"))

    _ = print_str(cast[*uint8]("  Collections: "))
    print_int(gc_get_total_collections())
    _ = print_str(cast[*uint8]("\n"))

    _ = print_str(cast[*uint8]("  Total freed: "))
    print_int(gc_get_total_freed())
    _ = print_str(cast[*uint8](" bytes\n"))

def main() -> int32:
    _ = print_str(cast[*uint8]("=== Brainhair GC Test ===\n\n"))

    # Initialize GC
    _ = print_str(cast[*uint8]("Initializing GC...\n"))
    if gc_init() == 0:
        _ = print_str(cast[*uint8]("ERROR: Failed to initialize GC\n"))
        return 1
    _ = print_str(cast[*uint8]("GC initialized successfully\n\n"))

    # Register global root
    _ = gc_register_root(cast[*int32](addr(global_obj)))

    # Test 1: Simple allocation
    _ = print_str(cast[*uint8]("Test 1: Simple allocation\n"))
    obj1: *uint8 = gc_alloc(64)
    if cast[int32](obj1) == 0:
        _ = print_str(cast[*uint8]("ERROR: Allocation failed\n"))
        return 1
    _ = print_str(cast[*uint8]("  Allocated 64 bytes\n"))
    print_stats()

    # Test 2: Multiple allocations
    _ = print_str(cast[*uint8]("\nTest 2: Multiple allocations (100 objects)\n"))
    i: int32 = 0
    while i < 100:
        obj: *uint8 = gc_alloc(128)
        if cast[int32](obj) == 0:
            _ = print_str(cast[*uint8]("ERROR: Allocation failed at "))
            print_int(i)
            _ = print_str(cast[*uint8]("\n"))
            return 1
        i = i + 1
    _ = print_str(cast[*uint8]("  Allocated 100 objects of 128 bytes each\n"))
    print_stats()

    # Test 3: Manual garbage collection
    _ = print_str(cast[*uint8]("\nTest 3: Manual garbage collection\n"))
    _ = print_str(cast[*uint8]("  (Objects from Test 2 should be freed since no refs)\n"))
    freed: int32 = gc_collect()
    _ = print_str(cast[*uint8]("  Freed: "))
    print_int(freed)
    _ = print_str(cast[*uint8](" bytes\n"))
    print_stats()

    # Test 4: Retained object via global root
    _ = print_str(cast[*uint8]("\nTest 4: Global root retention\n"))
    global_obj = gc_alloc(256)
    if cast[int32](global_obj) == 0:
        _ = print_str(cast[*uint8]("ERROR: Allocation failed\n"))
        return 1
    _ = print_str(cast[*uint8]("  Allocated 256 bytes to global_obj\n"))

    # Allocate more temporary objects
    i = 0
    while i < 50:
        _ = gc_alloc(64)
        i = i + 1
    _ = print_str(cast[*uint8]("  Allocated 50 temporary objects\n"))
    print_stats()

    # Collect - global_obj should survive
    _ = print_str(cast[*uint8]("\n  Running collection...\n"))
    freed = gc_collect()
    _ = print_str(cast[*uint8]("  Freed: "))
    print_int(freed)
    _ = print_str(cast[*uint8](" bytes\n"))
    _ = print_str(cast[*uint8]("  (global_obj should survive)\n"))
    print_stats()

    # Verify global_obj is still valid
    if cast[int32](global_obj) != 0:
        _ = print_str(cast[*uint8]("  global_obj still valid at: "))
        print_int(cast[int32](global_obj))
        _ = print_str(cast[*uint8]("\n"))
    else:
        _ = print_str(cast[*uint8]("ERROR: global_obj was incorrectly collected!\n"))
        return 1

    # Test 5: Stress test
    _ = print_str(cast[*uint8]("\nTest 5: Stress test (1000 allocations)\n"))
    i = 0
    while i < 1000:
        _ = gc_alloc(32)
        i = i + 1
    _ = print_str(cast[*uint8]("  Allocated 1000 objects of 32 bytes\n"))
    print_stats()

    # Final collection
    _ = print_str(cast[*uint8]("\nFinal collection...\n"))
    freed = gc_collect()
    _ = print_str(cast[*uint8]("  Freed: "))
    print_int(freed)
    _ = print_str(cast[*uint8](" bytes\n"))
    print_stats()

    # Cleanup
    gc_destroy()

    _ = print_str(cast[*uint8]("\n=== All tests passed! ===\n"))
    return 0
