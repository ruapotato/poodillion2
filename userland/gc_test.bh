# gc_test - Test program for Brainhair garbage collector

import "lib/syscalls"
import "lib/gc"

# Global root for testing
var global_obj: ptr uint8 = cast[ptr uint8](0)

proc print_str(s: ptr uint8): int32 =
    var len: int32 = 0
    while s[len] != 0:
        len = len + 1
    return syscall3(SYS_write, 1, cast[int32](s), len)

proc print_int(n: int32) =
    var old_brk: int32 = syscall1(SYS_brk, 0)
    discard syscall1(SYS_brk, old_brk + 32)
    var buf: ptr uint8 = cast[ptr uint8](old_brk)

    if n < 0:
        discard syscall3(SYS_write, 1, cast[int32](cast[ptr uint8]("-")), 1)
        n = 0 - n

    var i: int32 = 0
    if n == 0:
        buf[0] = 48  # '0'
        i = 1
    else:
        while n > 0:
            buf[i] = cast[uint8](48 + (n % 10))
            n = n / 10
            i = i + 1

    # Reverse
    var j: int32 = 0
    while j < i / 2:
        var t: uint8 = buf[j]
        buf[j] = buf[i - 1 - j]
        buf[i - 1 - j] = t
        j = j + 1

    discard syscall3(SYS_write, 1, cast[int32](buf), i)

proc print_stats() =
    discard print_str(cast[ptr uint8]("  Heap used: "))
    print_int(gc_get_heap_used())
    discard print_str(cast[ptr uint8](" bytes\n"))

    discard print_str(cast[ptr uint8]("  Objects: "))
    print_int(gc_get_object_count())
    discard print_str(cast[ptr uint8]("\n"))

    discard print_str(cast[ptr uint8]("  Total allocs: "))
    print_int(gc_get_total_allocations())
    discard print_str(cast[ptr uint8]("\n"))

    discard print_str(cast[ptr uint8]("  Collections: "))
    print_int(gc_get_total_collections())
    discard print_str(cast[ptr uint8]("\n"))

    discard print_str(cast[ptr uint8]("  Total freed: "))
    print_int(gc_get_total_freed())
    discard print_str(cast[ptr uint8](" bytes\n"))

proc main(): int32 =
    discard print_str(cast[ptr uint8]("=== Brainhair GC Test ===\n\n"))

    # Initialize GC
    discard print_str(cast[ptr uint8]("Initializing GC...\n"))
    if gc_init() == 0:
        discard print_str(cast[ptr uint8]("ERROR: Failed to initialize GC\n"))
        return 1
    discard print_str(cast[ptr uint8]("GC initialized successfully\n\n"))

    # Register global root
    discard gc_register_root(cast[ptr int32](addr(global_obj)))

    # Test 1: Simple allocation
    discard print_str(cast[ptr uint8]("Test 1: Simple allocation\n"))
    var obj1: ptr uint8 = gc_alloc(64)
    if cast[int32](obj1) == 0:
        discard print_str(cast[ptr uint8]("ERROR: Allocation failed\n"))
        return 1
    discard print_str(cast[ptr uint8]("  Allocated 64 bytes\n"))
    print_stats()

    # Test 2: Multiple allocations
    discard print_str(cast[ptr uint8]("\nTest 2: Multiple allocations (100 objects)\n"))
    var i: int32 = 0
    while i < 100:
        var obj: ptr uint8 = gc_alloc(128)
        if cast[int32](obj) == 0:
            discard print_str(cast[ptr uint8]("ERROR: Allocation failed at "))
            print_int(i)
            discard print_str(cast[ptr uint8]("\n"))
            return 1
        i = i + 1
    discard print_str(cast[ptr uint8]("  Allocated 100 objects of 128 bytes each\n"))
    print_stats()

    # Test 3: Manual garbage collection
    discard print_str(cast[ptr uint8]("\nTest 3: Manual garbage collection\n"))
    discard print_str(cast[ptr uint8]("  (Objects from Test 2 should be freed since no refs)\n"))
    var freed: int32 = gc_collect()
    discard print_str(cast[ptr uint8]("  Freed: "))
    print_int(freed)
    discard print_str(cast[ptr uint8](" bytes\n"))
    print_stats()

    # Test 4: Retained object via global root
    discard print_str(cast[ptr uint8]("\nTest 4: Global root retention\n"))
    global_obj = gc_alloc(256)
    if cast[int32](global_obj) == 0:
        discard print_str(cast[ptr uint8]("ERROR: Allocation failed\n"))
        return 1
    discard print_str(cast[ptr uint8]("  Allocated 256 bytes to global_obj\n"))

    # Allocate more temporary objects
    i = 0
    while i < 50:
        discard gc_alloc(64)
        i = i + 1
    discard print_str(cast[ptr uint8]("  Allocated 50 temporary objects\n"))
    print_stats()

    # Collect - global_obj should survive
    discard print_str(cast[ptr uint8]("\n  Running collection...\n"))
    freed = gc_collect()
    discard print_str(cast[ptr uint8]("  Freed: "))
    print_int(freed)
    discard print_str(cast[ptr uint8](" bytes\n"))
    discard print_str(cast[ptr uint8]("  (global_obj should survive)\n"))
    print_stats()

    # Verify global_obj is still valid
    if cast[int32](global_obj) != 0:
        discard print_str(cast[ptr uint8]("  global_obj still valid at: "))
        print_int(cast[int32](global_obj))
        discard print_str(cast[ptr uint8]("\n"))
    else:
        discard print_str(cast[ptr uint8]("ERROR: global_obj was incorrectly collected!\n"))
        return 1

    # Test 5: Stress test
    discard print_str(cast[ptr uint8]("\nTest 5: Stress test (1000 allocations)\n"))
    i = 0
    while i < 1000:
        discard gc_alloc(32)
        i = i + 1
    discard print_str(cast[ptr uint8]("  Allocated 1000 objects of 32 bytes\n"))
    print_stats()

    # Final collection
    discard print_str(cast[ptr uint8]("\nFinal collection...\n"))
    freed = gc_collect()
    discard print_str(cast[ptr uint8]("  Freed: "))
    print_int(freed)
    discard print_str(cast[ptr uint8](" bytes\n"))
    print_stats()

    # Cleanup
    gc_destroy()

    discard print_str(cast[ptr uint8]("\n=== All tests passed! ===\n"))
    return 0
