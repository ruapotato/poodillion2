# sha256_test.bh - SHA-256 Test Program for BrainhairOS
# Tests SHA-256 hash implementation with known test vectors

# Import SHA-256 library
import lib/sha256

# Import syscalls for I/O
extern syscall1(num: int32, arg1: int32): int32
extern syscall3(num: int32, arg1: int32, arg2: int32, arg3: int32): int32

const SYS_WRITE: int32 = 4
const STDOUT: int32 = 1

# Helper to print string
proc print(msg: ptr uint8) =
  var len: int32 = 0
  while msg[len] != cast[uint8](0):
    len = len + 1
  syscall3(SYS_WRITE, STDOUT, cast[int32](msg), len)

# Helper to print newline
proc println(msg: ptr uint8) =
  print(msg)
  var newline: array[1, uint8]
  newline[0] = cast[uint8](10)
  syscall3(SYS_WRITE, STDOUT, cast[int32](addr(newline[0])), 1)

# Main test function
proc main(): int32 =
  println(cast[ptr uint8]("=== SHA-256 Test Suite ==="))
  println(cast[ptr uint8](""))

  # Test 1: Empty string
  println(cast[ptr uint8]("Test 1: SHA-256(\"\")"))
  var hash1: array[32, uint8]
  var hex1: array[65, uint8]
  sha256_hash_string(cast[ptr uint8](""), addr(hash1[0]))
  sha256_to_hex(addr(hash1[0]), addr(hex1[0]))
  print(cast[ptr uint8]("Result:   "))
  println(addr(hex1[0]))
  println(cast[ptr uint8]("Expected: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"))
  println(cast[ptr uint8](""))

  # Test 2: "abc"
  println(cast[ptr uint8]("Test 2: SHA-256(\"abc\")"))
  var hash2: array[32, uint8]
  var hex2: array[65, uint8]
  sha256_hash_string(cast[ptr uint8]("abc"), addr(hash2[0]))
  sha256_to_hex(addr(hash2[0]), addr(hex2[0]))
  print(cast[ptr uint8]("Result:   "))
  println(addr(hex2[0]))
  println(cast[ptr uint8]("Expected: ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad"))
  println(cast[ptr uint8](""))

  # Test 3: "Hello, World!"
  println(cast[ptr uint8]("Test 3: SHA-256(\"Hello, World!\")"))
  var hash3: array[32, uint8]
  var hex3: array[65, uint8]
  sha256_hash_string(cast[ptr uint8]("Hello, World!"), addr(hash3[0]))
  sha256_to_hex(addr(hash3[0]), addr(hex3[0]))
  print(cast[ptr uint8]("Result:   "))
  println(addr(hex3[0]))
  println(cast[ptr uint8]("Expected: dffd6021bb2bd5b0af676290809ec3a53191dd81c7f70a4b28688a362182986f"))
  println(cast[ptr uint8](""))

  # Test 4: Incremental hashing
  println(cast[ptr uint8]("Test 4: Incremental hash of \"Hello, \" + \"World!\""))
  var ctx: SHA256
  sha256_init_ctx(addr(ctx))
  sha256_update_ctx(addr(ctx), cast[ptr uint8]("Hello, "), 7)
  sha256_update_ctx(addr(ctx), cast[ptr uint8]("World!"), 6)
  var hash4: array[32, uint8]
  var hex4: array[65, uint8]
  sha256_final_ctx(addr(ctx), addr(hash4[0]))
  sha256_to_hex(addr(hash4[0]), addr(hex4[0]))
  print(cast[ptr uint8]("Result:   "))
  println(addr(hex4[0]))
  println(cast[ptr uint8]("Expected: dffd6021bb2bd5b0af676290809ec3a53191dd81c7f70a4b28688a362182986f"))
  println(cast[ptr uint8](""))

  # Test 5: Hash comparison
  println(cast[ptr uint8]("Test 5: Compare hashes"))
  var hash5a: array[32, uint8]
  var hash5b: array[32, uint8]
  sha256_hash_string(cast[ptr uint8]("test"), addr(hash5a[0]))
  sha256_hash_string(cast[ptr uint8]("test"), addr(hash5b[0]))
  if sha256_compare(addr(hash5a[0]), addr(hash5b[0])) == 1:
    println(cast[ptr uint8]("✓ Hashes match (correct)"))
  else:
    println(cast[ptr uint8]("✗ Hashes don't match (error)"))

  sha256_hash_string(cast[ptr uint8]("test2"), addr(hash5b[0]))
  if sha256_compare(addr(hash5a[0]), addr(hash5b[0])) == 0:
    println(cast[ptr uint8]("✓ Different hashes don't match (correct)"))
  else:
    println(cast[ptr uint8]("✗ Different hashes match (error)"))
  println(cast[ptr uint8](""))

  # Test 6: HMAC-SHA256
  println(cast[ptr uint8]("Test 6: HMAC-SHA256(\"secret\", \"message\")"))
  var hmac: array[32, uint8]
  var hex_hmac: array[65, uint8]
  sha256_hmac(cast[ptr uint8]("secret"), 6, cast[ptr uint8]("message"), 7, addr(hmac[0]))
  sha256_to_hex(addr(hmac[0]), addr(hex_hmac[0]))
  print(cast[ptr uint8]("Result: "))
  println(addr(hex_hmac[0]))
  println(cast[ptr uint8](""))

  # Test 7: PBKDF2 (password-based key derivation)
  println(cast[ptr uint8]("Test 7: PBKDF2(\"password\", \"salt\", 100 iterations)"))
  var key: array[32, uint8]
  var hex_key: array[65, uint8]
  sha256_pbkdf2(cast[ptr uint8]("password"), 8, cast[ptr uint8]("salt"), 4, 100, addr(key[0]), 32)
  sha256_to_hex(addr(key[0]), addr(hex_key[0]))
  print(cast[ptr uint8]("Result: "))
  println(addr(hex_key[0]))
  println(cast[ptr uint8](""))

  println(cast[ptr uint8]("=== All tests complete! ==="))

  return 0
